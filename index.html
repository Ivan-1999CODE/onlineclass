<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英文單字冒險 (Unit 5 & 6 & Numbers)</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>
    
    <style>
        /* 避免載入時閃爍 */
        body { opacity: 0; transition: opacity 0.5s; }
        body.loaded { opacity: 1; }
        
        /* 針對 iOS Safari 的一些優化 */
        * { -webkit-tap-highlight-color: transparent; }
        
        /* 自定義捲軸樣式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* 拼字動畫 */
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
</head>
<body class="bg-sky-50">
    <div id="root"></div>

    <!-- 這裡開始是 React 程式碼 -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            BookOpen, Gamepad2, LayoutList, Layers, Volume2, ChevronLeft, ChevronRight, 
            CheckCircle, XCircle, Trophy, Star, Sparkles, HelpCircle, RefreshCw, Library, 
            Puzzle, Lightbulb, Music, Map, Wand2, Flag, AlertCircle, ArrowDownLeft, 
            Shuffle, GraduationCap, PenTool, Coffee, Keyboard, MousePointerClick, Filter, Eye, Timer, Home, Info
        } from 'lucide-react';

        // --- 語音與音效合成優化 ---
        let availableVoices = [];
        
        const loadVoices = () => {
            if (!window.speechSynthesis) return;
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                availableVoices = voices;
            }
        };

        loadVoices();
        if (window.speechSynthesis && window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        const speakText = (text) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            let selectedVoice = availableVoices.find(v => 
                (v.lang === 'en-US' || v.lang === 'en_US') && !v.name.includes("Network")
            );
            if (!selectedVoice) {
                selectedVoice = availableVoices.find(v => v.lang.includes('en'));
            }
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            utterance.pitch = 1;
            window.speechSynthesis.speak(utterance);
        };

        // 簡單的音效產生器 (Web Audio API)
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                if (type === 'correct') {
                    // 叮咚聲 (高音)
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(500, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.5);
                } else {
                    // 錯誤聲 (低音鋸齒波)
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.3);
                }
            } catch (e) {
                console.error("Audio play failed", e);
            }
        };

        // --- 工具函式 ---
        const shuffleArray = (array) => {
            if (!array) return [];
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        // --- 1. 基數 (Cardinal) 生成器 ---
        const generateNumberVocab = () => {
            const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            const vocab = [];
            for (let i = 1; i <= 100; i++) {
                let word = '';
                if (i === 100) word = 'one hundred';
                else if (i < 20) word = ones[i];
                else word = tens[Math.floor(i / 10)] + (i % 10 !== 0 ? '-' + ones[i % 10] : '');
                
                vocab.push({
                    id: `num-${i}`,
                    word: word,
                    part: "num.",
                    chinese: i.toString(),
                    sentence: i === 1 ? `I have one apple.` : `I have ${word} apples.`,
                    sentence_ch: `我有 ${i} 顆蘋果。`
                });
            }
            return vocab;
        };

        const generateNumberQuizPool = () => {
            const pool = [];
            pool.push({ q: "25 = twenty-______", options: ["five", "fifth", "fives"], ans: "five", hint: "25 是基數。" });
            pool.push({ q: "40 = ______", options: ["fourty", "forty", "fourti"], ans: "forty", hint: "注意 forty 的拼法，沒有 u。" });
            pool.push({ q: "99 = ninety-______", options: ["nine", "ninty", "one"], ans: "nine", hint: "99 是 ninety-nine。" });
            pool.push({ q: "100 = one ______", options: ["hundred", "thousand", "million"], ans: "hundred", hint: "百是 hundred。" });
            pool.push({ q: "12 = ______", options: ["twelve", "twelf", "two"], ans: "twelve", hint: "12 是 twelve。" });
            
            for(let i=0; i<45; i++) {
                const num = Math.floor(Math.random() * 80) + 20; 
                const ones = ['one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
                const tens = ['twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
                const tenDigit = Math.floor(num/10);
                const oneDigit = num % 10;
                if(oneDigit === 0) continue; 
                
                const qType = Math.random();
                if(qType > 0.5) {
                     pool.push({ 
                        q: `${num} = ${tens[tenDigit-2]}-______`, 
                        options: [ones[oneDigit-1], ones[(oneDigit+1)%9], ones[(oneDigit+2)%9]], 
                        ans: ones[oneDigit-1], 
                        hint: `${num} 的個位數是 ${ones[oneDigit-1]}`
                    });
                } else {
                     pool.push({ 
                        q: `${num} = ______-${ones[oneDigit-1]}`, 
                        options: [tens[tenDigit-2], tens[(tenDigit)%8], tens[(tenDigit+1)%8]], 
                        ans: tens[tenDigit-2], 
                        hint: `${num} 的十位數是 ${tens[tenDigit-2]}`
                    });
                }
            }
            return pool.slice(0, 50);
        };

        const generateNumberScramblePool = () => {
            const templates = [
                { s: "I have [NUM] apples.", ch: "我有[NUM]顆蘋果。" },
                { s: "She is [NUM] years old.", ch: "她[NUM]歲了。" },
                { s: "There are [NUM] students.", ch: "有[NUM]位學生。" },
                { s: "It is number [NUM].", ch: "它是[NUM]號。" },
                { s: "I see [NUM] birds.", ch: "我看見[NUM]隻鳥。" },
            ];
            const numbers = ["one", "two", "three", "ten", "twenty", "thirty", "forty", "fifty", "one hundred", "ninety-nine"];
            const numCh = ["一", "二", "三", "十", "二十", "三十", "四十", "五十", "一百", "九十九"];
            const pool = [];
            for(let i=0; i<50; i++) {
                const tIndex = i % templates.length;
                const nIndex = Math.floor(Math.random() * numbers.length);
                pool.push({
                    id: `n-sc-${i}`,
                    sentence: templates[tIndex].s.replace("[NUM]", numbers[nIndex]),
                    sentence_ch: templates[tIndex].ch.replace("[NUM]", numCh[nIndex])
                });
            }
            return pool;
        };

        // --- 2. 序數 (Ordinal) 生成器 (1-100) ---
        const generateOrdinalVocab = () => {
            const ordinals1to19 = [
                '', 'first', 'second', 'third', 'fourth', 'fifth', 'sixth', 'seventh', 'eighth', 'ninth', 'tenth',
                'eleventh', 'twelfth', 'thirteenth', 'fourteenth', 'fifteenth', 'sixteenth', 'seventeenth', 'eighteenth', 'nineteenth'
            ];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            const ordinalsTens = ['', '', 'twentieth', 'thirtieth', 'fortieth', 'fiftieth', 'sixtieth', 'seventieth', 'eightieth', 'ninetieth'];

            const vocab = [];
            for (let i = 1; i <= 100; i++) {
                let word = '';
                let abbreviation = i + 'th';

                // 處理縮寫 (st, nd, rd, th)
                if (i % 10 === 1 && i % 100 !== 11) abbreviation = i + 'st';
                else if (i % 10 === 2 && i % 100 !== 12) abbreviation = i + 'nd';
                else if (i % 10 === 3 && i % 100 !== 13) abbreviation = i + 'rd';

                // 生成單字
                if (i === 100) word = 'one hundredth';
                else if (i < 20) word = ordinals1to19[i];
                else if (i % 10 === 0) word = ordinalsTens[Math.floor(i / 10)];
                else {
                    const tenPart = tens[Math.floor(i / 10)];
                    const onePart = ordinals1to19[i % 10];
                    word = `${tenPart}-${onePart}`;
                }

                vocab.push({
                    id: `ord-${i}`,
                    word: word,
                    part: "adj.",
                    chinese: `第 ${i}`,
                    sentence: `This is the ${word} time I have been here.`,
                    sentence_ch: `這是我第 ${i} 次來這裡。`
                });
            }
            return vocab;
        };

        const generateOrdinalQuizPool = () => {
            const pool = [];
            // 基本不規則
            pool.push({ q: "1st = ______", options: ["first", "one", "onest"], ans: "first", hint: "第一是不規則變化。" });
            pool.push({ q: "2nd = ______", options: ["second", "two", "twond"], ans: "second", hint: "第二是不規則變化。" });
            pool.push({ q: "3rd = ______", options: ["third", "three", "threerd"], ans: "third", hint: "第三是不規則變化。" });
            pool.push({ q: "5th = ______", options: ["fifth", "fiveth", "five"], ans: "fifth", hint: "Five 變成 Fifth (ve -> f)。" });
            pool.push({ q: "9th = ______", options: ["ninth", "nineth", "nine"], ans: "ninth", hint: "Nine 去掉 e 變成 Ninth。" });
            pool.push({ q: "12th = ______", options: ["twelfth", "twelveth", "twelve"], ans: "twelfth", hint: "Twelve (ve -> fth)。" });
            pool.push({ q: "20th = ______", options: ["twentieth", "twentyth", "twenteth"], ans: "twentieth", hint: "Twenty (y -> ieth)。" });
            pool.push({ q: "21st = twenty-______", options: ["first", "one", "onest"], ans: "first", hint: "21st = 20 + 1st。" });
            pool.push({ q: "32nd = thirty-______", options: ["second", "two", "twoth"], ans: "second", hint: "32nd = 30 + 2nd。" });
            pool.push({ q: "53rd = fifty-______", options: ["third", "three", "threeth"], ans: "third", hint: "53rd = 50 + 3rd。" });
            
            // 隨機生成題目
            for(let i=0; i<30; i++) {
                const num = Math.floor(Math.random() * 80) + 20; 
                // 排除整數，專注在複合字
                if(num % 10 === 0) continue; 
                
                const ones = ['first', 'second', 'third', 'fourth', 'fifth', 'sixth', 'seventh', 'eighth', 'ninth'];
                const tens = ['twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
                
                const tenDigit = Math.floor(num/10);
                const oneDigit = num % 10;
                
                const correctAns = ones[oneDigit-1];
                const wrongAns1 = ones[(oneDigit+1)%9];
                
                pool.push({ 
                    q: `第 ${num} (${num}${['st','nd','rd'][oneDigit-1] || 'th'}) = ${tens[tenDigit-2]}-______`, 
                    options: [correctAns, wrongAns1, "th"], 
                    ans: correctAns, 
                    hint: `第 ${num} 的尾數是第 ${oneDigit}`
                });
            }
            return shuffleArray(pool).slice(0, 50);
        }; // FIXED: Missing closing brace

        const generateOrdinalScramblePool = () => {
            const templates = [
                { s: "This is my [ORD] time.", ch: "這是我的第[NUM]次。" },
                { s: "He won [ORD] prize.", ch: "他贏得了第[NUM]名。" },
                { s: "Today is my [ORD] birthday.", ch: "今天是我的第[NUM]個生日。" },
                { s: "The classroom is on the [ORD] floor.", ch: "教室在第[NUM]樓。" },
            ];
            const mapping = [
                {w: "first", n: "一"}, {w: "second", n: "二"}, {w: "third", n: "三"}, {w: "fifth", n: "五"},
                {w: "ninth", n: "九"}, {w: "twelfth", n: "十二"}, {w: "twentieth", n: "二十"}, {w: "twenty-first", n: "二十一"}
            ];
            
            const pool = [];
            for(let i=0; i<40; i++) {
                const tIndex = i % templates.length;
                const mIndex = Math.floor(Math.random() * mapping.length);
                pool.push({
                    id: `ord-sc-${i}`,
                    sentence: templates[tIndex].s.replace("[ORD]", mapping[mIndex].w),
                    sentence_ch: templates[tIndex].ch.replace("[NUM]", mapping[mIndex].n)
                });
            }
            return pool;
        };

        // --- Unit 5 題庫生成 (擴充至100題) ---
        const generateUnit5QuizPool = () => {
            const pool = [
                // 1. 詢問交通方式 (How...) - 20題
                { q: "______ do you go to school?", options: ["How", "What", "Where"], ans: "How", hint: "詢問「如何」去某地，使用 How。" },
                { q: "How ______ she go to the park?", options: ["does", "do", "is"], ans: "does", hint: "主詞是 She (第三人稱單數)，助動詞用 does。" },
                { q: "How ______ they get to the zoo?", options: ["do", "does", "are"], ans: "do", hint: "主詞是 They (複數)，助動詞用 do。" },
                { q: "How does John ______ to work?", options: ["go", "goes", "going"], ans: "go", hint: "前面有助動詞 does，後面動詞用原形 go。" },
                { q: "______ do the students go home?", options: ["How", "Who", "When"], ans: "How", hint: "詢問交通方式用 How。" },
                { q: "How ______ your father go to the office?", options: ["does", "do", "is"], ans: "does", hint: "Father 是單數，用 does。" },
                { q: "How ______ we get there?", options: ["do", "does", "are"], ans: "do", hint: "We 是複數，用 do。" },
                { q: "______ does Mary go to the library?", options: ["How", "What", "Where"], ans: "How", hint: "詢問方式。" },
                { q: "How do you ______ to the island?", options: ["get", "gets", "getting"], ans: "get", hint: "do 後面接原形動詞。" },
                { q: "How ______ the teacher go to school?", options: ["does", "do", "is"], ans: "does", hint: "Teacher 是單數。" },
                { q: "How ______ your brother go to the gym?", options: ["does", "do", "is"], ans: "does", hint: "Brother 是單數。" },
                { q: "How ______ Alice and Bob go to the party?", options: ["do", "does", "are"], ans: "do", hint: "Alice and Bob 是複數。" },
                { q: "______ can I get to the museum?", options: ["How", "What", "Where"], ans: "How", hint: "詢問如何到達。" },
                { q: "How ______ the dog go home?", options: ["does", "do", "is"], ans: "does", hint: "Dog 是單數。" },
                { q: "How ______ you go to Taipei 101?", options: ["do", "are", "does"], ans: "do", hint: "You 用 do。" },
                { q: "______ does he go to the supermarket?", options: ["How", "What", "Who"], ans: "How", hint: "詢問交通方式。" },
                { q: "How do ______ go to the beach?", options: ["they", "he", "she"], ans: "they", hint: "助動詞是 do，主詞用複數 they。" },
                { q: "How does ______ go to the mountains?", options: ["she", "they", "we"], ans: "she", hint: "助動詞是 does，主詞用單數 she。" },
                { q: "How ______ Mr. Lin go to work?", options: ["does", "do", "is"], ans: "does", hint: "Mr. Lin 是單數。" },
                { q: "How ______ the boys go to the park?", options: ["do", "does", "are"], ans: "do", hint: "The boys 是複數。" },

                // 2. 交通方式 (by vs take/ride/drive) - 30題
                { q: "We go to Taipei ______ train.", options: ["by", "in", "on"], ans: "by", hint: "by + 交通工具 (不加冠詞)。" },
                { q: "He goes to work ______ car.", options: ["by", "in", "on"], ans: "by", hint: "by + 交通工具 (不加冠詞)。" },
                { q: "They go to the zoo ______ foot.", options: ["on", "by", "in"], ans: "on", hint: "走路固定用 on foot。" },
                { q: "I ______ a bus to school every day.", options: ["take", "by", "go"], ans: "take", hint: "動詞 take + a/the + 交通工具。" },
                { q: "She ______ a bicycle to the market.", options: ["rides", "by", "takes"], ans: "rides", hint: "騎腳踏車用 rides。" },
                { q: "Let's go there ______ metro.", options: ["by", "on", "in"], ans: "by", hint: "by metro。" },
                { q: "My dad ______ a car to work.", options: ["drives", "takes", "rides"], ans: "drives", hint: "開車用 drives。" },
                { q: "Can we ______ a taxi?", options: ["take", "by", "go"], ans: "take", hint: "搭計程車 take a taxi。" },
                { q: "He comes here ______ motorcycle.", options: ["by", "on", "in"], ans: "by", hint: "by motorcycle。" },
                { q: "They go to the USA ______ plane.", options: ["by", "on", "in"], ans: "by", hint: "by plane。" },
                { q: "She ______ the train to Taipei.", options: ["takes", "take", "by"], ans: "takes", hint: "She (單數) 用 takes。" },
                { q: "I usually go to school ______ bike.", options: ["by", "on", "in"], ans: "by", hint: "by bike。" },
                { q: "Don't go there ______ foot. It's too far.", options: ["on", "by", "with"], ans: "on", hint: "on foot (走路)。" },
                { q: "We can ______ a boat to the island.", options: ["take", "by", "go"], ans: "take", hint: "take a boat。" },
                { q: "He ______ his scooter to the park.", options: ["rides", "takes", "drives"], ans: "rides", hint: "騎機車用 rides。" },
                { q: "Do you go to school ______ bus?", options: ["by", "on", "in"], ans: "by", hint: "by bus。" },
                { q: "My mom ______ me to school.", options: ["drives", "rides", "takes"], ans: "drives", hint: "開車載某人用 drives。" },
                { q: "They ______ a plane to Japan.", options: ["take", "ride", "by"], ans: "take", hint: "搭飛機 take a plane。" },
                { q: "Can we go there ______ ship?", options: ["by", "on", "in"], ans: "by", hint: "by ship。" },
                { q: "He walks to school. He goes to school ______ foot.", options: ["on", "by", "in"], ans: "on", hint: "走路 on foot。" },
                { q: "She never ______ a taxi.", options: ["takes", "take", "by"], ans: "takes", hint: "She takes。" },
                { q: "Let's ______ the metro.", options: ["take", "by", "go"], ans: "take", hint: "搭捷運 take the metro。" },
                { q: "I like to ______ my bike.", options: ["ride", "drive", "take"], ans: "ride", hint: "騎車 ride。" },
                { q: "They go to Kaohsiung ______ HSR.", options: ["by", "on", "in"], ans: "by", hint: "by HSR (高鐵)。" },
                { q: "Do you want to ______ a bus?", options: ["take", "by", "go"], ans: "take", hint: "take a bus。" },
                { q: "He goes to the park ______ bike.", options: ["by", "on", "in"], ans: "by", hint: "by bike。" },
                { q: "My sister ______ the bus to school.", options: ["takes", "rides", "drives"], ans: "takes", hint: "搭公車 takes the bus。" },
                { q: "Is it faster to go ______ taxi?", options: ["by", "on", "in"], ans: "by", hint: "by taxi。" },
                { q: "They ______ a boat across the river.", options: ["took", "by", "on"], ans: "took", hint: "搭船 took a boat (過去式)。" },
                { q: "We can go there ______ scooter.", options: ["by", "on", "in"], ans: "by", hint: "by scooter。" },

                // 3. 問路與指引 (How to get to / Imperatives) - 25題
                { q: "How can I ______ to the station?", options: ["get", "go", "take"], ans: "get", hint: "到達用 get to。" },
                { q: "______ straight for two blocks.", options: ["Go", "Going", "To go"], ans: "Go", hint: "祈使句用原形動詞 Go 開頭。" },
                { q: "______ down this road.", options: ["Walk", "Walking", "To walk"], ans: "Walk", hint: "祈使句用原形動詞 Walk 開頭。" },
                { q: "Turn ______ at the second traffic light.", options: ["right", "light", "straight"], ans: "right", hint: "右轉 Turn right。" },
                { q: "Go ______ along the river.", options: ["straight", "street", "right"], ans: "straight", hint: "直走 Go straight。" },
                { q: "______ me. Where is the bank?", options: ["Excuse", "Sorry", "Hello"], ans: "Excuse", hint: "Excuse me (不好意思)。" },
                { q: "How do I ______ to the hospital?", options: ["get", "go", "arrive"], ans: "get", hint: "get to + 地點。" },
                { q: "______ left at the corner.", options: ["Turn", "Go", "Walk"], ans: "Turn", hint: "左轉 Turn left。" },
                { q: "Go straight ______ one block.", options: ["for", "to", "at"], ans: "for", hint: "持續一個街區用 for。" },
                { q: "Can you ______ me the way?", options: ["tell", "say", "speak"], ans: "tell", hint: "告訴我路 tell me the way。" },
                { q: "______ along this street and turn left.", options: ["Walk", "Walking", "To walk"], ans: "Walk", hint: "祈使句用原形 Walk。" },
                { q: "The bank is on ______ right.", options: ["your", "you", "yours"], ans: "your", hint: "on your right (在你的右手邊)。" },
                { q: "Go ______ three blocks.", options: ["for", "to", "at"], ans: "for", hint: "走三個街區 Go for..." },
                { q: "______ the street at the light.", options: ["Cross", "Across", "Crossing"], ans: "Cross", hint: "穿越街道 Cross the street (動詞)。" },
                { q: "Stop ______ the red light.", options: ["at", "on", "in"], ans: "at", hint: "停在... Stop at。" },
                { q: "Go down this road ______ two blocks.", options: ["for", "to", "at"], ans: "for", hint: "持續兩條街用 for。" },
                { q: "______ right and you will see it.", options: ["Turn", "Go", "Walk"], ans: "Turn", hint: "右轉 Turn right。" },
                { q: "It is ______ your left.", options: ["on", "in", "at"], ans: "on", hint: "在左邊 on your left。" },
                { q: "Can you show me the ______?", options: ["way", "road", "street"], ans: "way", hint: "指路 show me the way。" },
                { q: "Don't ______ left here.", options: ["turn", "turning", "turns"], ans: "turn", hint: "助動詞 Don't 後接原形。" },
                { q: "Go ______ this street.", options: ["along", "long", "with"], ans: "along", hint: "沿著 Go along。" },
                { q: "It's ______ the corner.", options: ["around", "round", "about"], ans: "around", hint: "就在轉角附近 around the corner。" },
                { q: "______ straight and stop at the bank.", options: ["Go", "Walks", "Going"], ans: "Go", hint: "祈使句用 Go。" },
                { q: "How ______ we get to the zoo?", options: ["can", "are", "is"], ans: "can", hint: "How can we...?" },
                { q: "Please ______ me the map.", options: ["show", "see", "look"], ans: "show", hint: "給我看 show me。" },

                // 4. 方位介系詞 (Prepositions) - 25題
                { q: "The bank is ______ the post office and the park.", options: ["between", "among", "next"], ans: "between", hint: "在 A 和 B 之間用 between。" },
                { q: "The school is ______ from the library.", options: ["across", "next", "between"], ans: "across", hint: "在...對面用 across from。" },
                { q: "It is on the ______ of First St. and Main St.", options: ["corner", "block", "side"], ans: "corner", hint: "在轉角用 on the corner of。" },
                { q: "The shop is ______ to the bakery.", options: ["next", "near", "across"], ans: "next", hint: "在...旁邊用 next to。" },
                { q: "The museum is ______ Green Road.", options: ["on", "at", "in"], ans: "on", hint: "在路上用 on + 路名。" },
                { q: "The park is across ______ the school.", options: ["from", "to", "with"], ans: "from", hint: "across from。" },
                { q: "My house is ______ the library.", options: ["near", "next", "between"], ans: "near", hint: "在...附近 (near)，next 需加 to。" },
                { q: "The bus stop is in ______ of the zoo.", options: ["front", "back", "side"], ans: "front", hint: "在...前面 in front of。" },
                { q: "Stand ______ the middle of the room.", options: ["in", "on", "at"], ans: "in", hint: "在中間 in the middle。" },
                { q: "The bird is ______ the tree.", options: ["in", "on", "at"], ans: "in", hint: "躲在樹裡面用 in the tree。" },
                { q: "The dog is sleeping ______ the table.", options: ["under", "in", "between"], ans: "under", hint: "在...下面 under。" },
                { q: "There is a 7-11 ______ the corner.", options: ["on", "in", "to"], ans: "on", hint: "在轉角 on the corner。" },
                { q: "The river is ______ the school.", options: ["behind", "between", "next"], ans: "behind", hint: "在...後面 behind。" },
                { q: "Is the bank ______ to the market?", options: ["next", "near", "across"], ans: "next", hint: "next to。" },
                { q: "The library is ______ First Street.", options: ["on", "in", "at"], ans: "on", hint: "在街道上用 on。" },
                { q: "I sit ______ John and Mary.", options: ["between", "next", "across"], ans: "between", hint: "在兩者之間 between。" },
                { q: "The ball is ______ the box.", options: ["in", "on", "at"], ans: "in", hint: "在...裡面 in。" },
                { q: "There is a park ______ from my house.", options: ["across", "next", "near"], ans: "across", hint: "across from (對面)。" },
                { q: "The cat is ______ the sofa.", options: ["on", "in", "at"], ans: "on", hint: "在...上面 on。" },
                { q: "My school is next ______ the park.", options: ["to", "of", "from"], ans: "to", hint: "next to。" },
                { q: "He stands in front ______ the door.", options: ["of", "off", "to"], ans: "of", hint: "in front of。" },
                { q: "The kite is ______ the sky.", options: ["in", "on", "at"], ans: "in", hint: "在天空中用 in the sky。" },
                { q: "Is there a bank ______ here?", options: ["near", "next", "between"], ans: "near", hint: "在附近 near here。" },
                { q: "The restaurant is on the ______.", options: ["corner", "middle", "between"], ans: "corner", hint: "on the corner。" },
                { q: "Who is standing ______ you?", options: ["behind", "between", "across"], ans: "behind", hint: "在你後面 behind you。" }
            ];

            return shuffleArray(pool);
        };

        // --- Unit 5 重組生成器 (改為使用新單字例句) ---
        const generateUnit5ScramblePool = (vocabData) => {
            // 自動從 Vocab Data 生成重組題目
            if (!vocabData) return [];
            return vocabData.map((item, index) => ({
                id: `u5-sc-${index}`,
                sentence: item.sentence.replace(/A: |B: /g, ''), // 移除對話標籤 A: B: 避免混淆
                sentence_ch: item.sentence_ch.replace(/A: |B: /g, '')
            }));
        };

        // --- Unit 6 題庫生成 (擴充至100題) ---
        const generateUnit6QuizPool = () => {
            const pool = [
                // 1. 未來式 (will) - 25題
                { q: "I ______ visit my grandma tomorrow.", options: ["will", "am", "did"], ans: "will", hint: "明天 (tomorrow) 用未來式 will。" },
                { q: "He ______ not go to the party.", options: ["will", "is", "does"], ans: "will", hint: "未來式否定 will not。" },
                { q: "______ you come with us?", options: ["Will", "Do", "Are"], ans: "Will", hint: "未來式疑問句用 Will 開頭。" },
                { q: "Yes, I ______.", options: ["will", "do", "am"], ans: "will", hint: "Will 問，Will 答。" },
                { q: "They ______ play basketball next week.", options: ["will", "are", "do"], ans: "will", hint: "下週 (next week) 用未來式 will。" },
                { q: "She ______ be late.", options: ["will", "is", "does"], ans: "will", hint: "will 後面接原形動詞 be。" },
                { q: "We ______ go camping tomorrow.", options: ["won't", "don't", "aren't"], ans: "won't", hint: "will not 的縮寫是 won't。" },
                { q: "______ he buy a new car?", options: ["Will", "Is", "Does"], ans: "Will", hint: "未來式疑問句 Will。" },
                { q: "It ______ rain this afternoon.", options: ["will", "is", "does"], ans: "will", hint: "下午將會下雨，用 will。" },
                { q: "No, she ______.", options: ["won't", "don't", "isn't"], ans: "won't", hint: "否定簡答用 won't。" },
                { q: "I think he ______ come.", options: ["will", "is", "does"], ans: "will", hint: "我認為他會來。" },
                { q: "Where ______ you go tomorrow?", options: ["will", "do", "are"], ans: "will", hint: "明天要去哪裡？" },
                { q: "Mom ______ cook dinner tonight.", options: ["will", "is", "does"], ans: "will", hint: "今晚將會煮晚餐。" },
                { q: "They ______ be happy.", options: ["will", "are", "do"], ans: "will", hint: "他們將會很高興。" },
                { q: "Who ______ win the game?", options: ["will", "is", "does"], ans: "will", hint: "誰將會贏？" },
                { q: "______ it be sunny tomorrow?", options: ["Will", "Is", "Does"], ans: "Will", hint: "明天會是晴天嗎？" },
                { q: "I ______ call you later.", options: ["will", "am", "do"], ans: "will", hint: "我晚點會打給你。" },
                { q: "She ______ not like the gift.", options: ["will", "is", "does"], ans: "will", hint: "她將不會喜歡這個禮物。" },
                { q: "Maybe it ______ snow.", options: ["will", "is", "does"], ans: "will", hint: "也許會下雪。" },
                { q: "______ they come to the party?", options: ["Will", "Do", "Are"], ans: "Will", hint: "他們會來嗎？" },
                { q: "The bus ______ arrive soon.", options: ["will", "is", "does"], ans: "will", hint: "公車快到了。" },
                { q: "We ______ study hard.", options: ["will", "are", "do"], ans: "will", hint: "我們會努力讀書。" },
                { q: "There ______ be a test tomorrow.", options: ["will", "is", "has"], ans: "will", hint: "明天會有考試 (will be)。" },
                { q: "What ______ happen?", options: ["will", "is", "does"], ans: "will", hint: "會發生什麼事？" },
                { q: "I promise I ______ help you.", options: ["will", "am", "do"], ans: "will", hint: "我承諾我會幫你。" },

                // 2. 未來式 (be going to) - 25題
                { q: "She ______ going to buy a dress.", options: ["is", "will", "does"], ans: "is", hint: "be going to 句型，She 配 is。" },
                { q: "We ______ going to play soccer.", options: ["are", "will", "do"], ans: "are", hint: "be going to 句型，We 配 are。" },
                { q: "What ______ you going to do?", options: ["are", "do", "will"], ans: "are", hint: "What are you going to...?" },
                { q: "I ______ going to study English.", options: ["am", "will", "do"], ans: "am", hint: "I 配 am。" },
                { q: "They ______ not going to watch TV.", options: ["are", "will", "do"], ans: "are", hint: "They 配 are。" },
                { q: "______ he going to swim?", options: ["Is", "Will", "Does"], ans: "Is", hint: "He 配 Is。" },
                { q: "It ______ going to rain.", options: ["is", "will", "does"], ans: "is", hint: "It 配 is。" },
                { q: "Where ______ she going to go?", options: ["is", "does", "will"], ans: "is", hint: "She 配 is。" },
                { q: "______ you going to eat?", options: ["Are", "Do", "Will"], ans: "Are", hint: "You 配 Are。" },
                { q: "My friends ______ going to come.", options: ["are", "is", "will"], ans: "are", hint: "Friends (複數) 配 are。" },
                { q: "Who ______ going to help me?", options: ["is", "are", "will"], ans: "is", hint: "Who 當主詞通常視為單數 is。" },
                { q: "The boys ______ going to run.", options: ["are", "is", "will"], ans: "are", hint: "Boys 配 are。" },
                { q: "I am ______ to sleep.", options: ["going", "go", "will"], ans: "going", hint: "be going to。" },
                { q: "Are they ______ to visit us?", options: ["going", "go", "will"], ans: "going", hint: "Are... going to...?" },
                { q: "Is Mom ______ to cook?", options: ["going", "go", "will"], ans: "going", hint: "Is... going to...?" },
                { q: "We are ______ to have fun.", options: ["going", "go", "will"], ans: "going", hint: "We are going to..." },
                { q: "What ______ they going to eat?", options: ["are", "is", "will"], ans: "are", hint: "They 配 are。" },
                { q: "______ John going to play?", options: ["Is", "Are", "Will"], ans: "Is", hint: "John 配 Is。" },
                { q: "They aren't ______ to leave.", options: ["going", "go", "will"], ans: "going", hint: "aren't going to。" },
                { q: "I'm not ______ to buy it.", options: ["going", "go", "will"], ans: "going", hint: "not going to。" },
                { q: "When ______ you going to start?", options: ["are", "is", "will"], ans: "are", hint: "You 配 are。" },
                { q: "Where ______ he going to stay?", options: ["is", "are", "will"], ans: "is", hint: "He 配 is。" },
                { q: "______ it going to be hot?", options: ["Is", "Are", "Will"], ans: "Is", hint: "It 配 Is。" },
                { q: "You ______ going to be late.", options: ["are", "is", "will"], ans: "are", hint: "You are going to..." },
                { q: "My sister ______ going to dance.", options: ["is", "are", "will"], ans: "is", hint: "Sister 配 is。" },

                // 3. 花費金錢 (cost/spend/pay) - 25題
                { q: "The watch ______ me 5000 dollars.", options: ["cost", "spent", "paid"], ans: "cost", hint: "物品 (The watch) 當主詞，用 cost。" },
                { q: "I ______ 100 dollars on the book.", options: ["spent", "cost", "paid"], ans: "spent", hint: "人 (I) 當主詞，後面接 on，用 spent。" },
                { q: "He ______ 200 dollars for the ticket.", options: ["paid", "cost", "spent"], ans: "paid", hint: "人 (He) 當主詞，後面接 for，用 paid。" },
                { q: "How much did it ______?", options: ["cost", "spend", "pay"], ans: "cost", hint: "物品 (it) 當主詞，用 cost。" },
                { q: "She spends money ______ clothes.", options: ["on", "in", "for"], ans: "on", hint: "spend 金錢 on 物品。" },
                { q: "I paid money ______ the food.", options: ["for", "on", "to"], ans: "for", hint: "pay 金錢 for 物品。" },
                { q: "The car ______ a lot of money.", options: ["costs", "spends", "pays"], ans: "costs", hint: "物品 (The car) 當主詞，用 costs。" },
                { q: "Don't ______ too much money.", options: ["spend", "cost", "take"], ans: "spend", hint: "人當主詞，花錢用 spend。" },
                { q: "How much did you ______ for the bag?", options: ["pay", "cost", "spend"], ans: "pay", hint: "搭配 for，用 pay。" },
                { q: "This pen ______ only 10 dollars.", options: ["costs", "pays", "spends"], ans: "costs", hint: "物品當主詞用 costs。" },
                { q: "I ______ 50 dollars buying the drink.", options: ["spent", "cost", "paid"], ans: "spent", hint: "spend + 錢 + V-ing。" },
                { q: "Did you ______ for the ticket?", options: ["pay", "cost", "spend"], ans: "pay", hint: "pay for something。" },
                { q: "The trip will ______ a lot.", options: ["cost", "spend", "pay"], ans: "cost", hint: "物品/事情 (Trip) 當主詞，用 cost。" },
                { q: "She ______ all her money on shoes.", options: ["spent", "cost", "paid"], ans: "spent", hint: "spend money on..." },
                { q: "Can I ______ by credit card?", options: ["pay", "cost", "spend"], ans: "pay", hint: "付款用 pay。" },
                { q: "The bike ______ him 2000 dollars.", options: ["cost", "spent", "paid"], ans: "cost", hint: "物品 cost 人 錢。" },
                { q: "He ______ 500 dollars on the game.", options: ["spent", "cost", "took"], ans: "spent", hint: "人 spent 錢 on..." },
                { q: "How much does the hat ______?", options: ["cost", "pay", "spend"], ans: "cost", hint: "物品當主詞用 cost。" },
                { q: "I ______ cash for the dinner.", options: ["paid", "spent", "cost"], ans: "paid", hint: "pay cash for..." },
                { q: "This computer ______ too much.", options: ["costs", "pays", "spends"], ans: "costs", hint: "物品 costs。" },
                { q: "They ______ a lot on travel.", options: ["spend", "cost", "pay"], ans: "spend", hint: "spend on..." },
                { q: "Did she ______ for the coffee?", options: ["pay", "cost", "spend"], ans: "pay", hint: "pay for..." },
                { q: "It ______ me 100 dollars.", options: ["cost", "spent", "paid"], ans: "cost", hint: "It cost me..." },
                { q: "We ______ 300 dollars buying gifts.", options: ["spent", "cost", "paid"], ans: "spent", hint: "spent + 錢 + V-ing。" },
                { q: "Please ______ at the counter.", options: ["pay", "cost", "spend"], ans: "pay", hint: "結帳用 pay。" },

                // 4. 花費時間 (take/spend) - 25題
                { q: "It ______ me ten minutes to walk home.", options: ["took", "spent", "cost"], ans: "took", hint: "虛主詞 It 開頭表花時間，用 took/takes。" },
                { q: "It takes one hour ______ cook dinner.", options: ["to", "for", "in"], ans: "to", hint: "It takes 時間 to V (不定詞)。" },
                { q: "He spent two hours ______ TV.", options: ["watching", "watch", "to watch"], ans: "watching", hint: "人 spend 時間 V-ing (動名詞)。" },
                { q: "We spent the whole day ______.", options: ["shopping", "shop", "to shop"], ans: "shopping", hint: "人 spend 時間 V-ing。" },
                { q: "How long does it ______ to get there?", options: ["take", "spend", "cost"], ans: "take", hint: "It 當主詞，用 take。" },
                { q: "It ______ about 30 minutes.", options: ["takes", "spends", "costs"], ans: "takes", hint: "It 當主詞，用 takes。" },
                { q: "I ______ an hour cleaning my room.", options: ["spent", "took", "cost"], ans: "spent", hint: "人當主詞，花時間用 spent。" },
                { q: "It takes time ______ learn English.", options: ["to", "for", "in"], ans: "to", hint: "to + 原形動詞。" },
                { q: "She spends time ______ the piano.", options: ["practicing", "practice", "to practice"], ans: "practicing", hint: "spend + 時間 + V-ing。" },
                { q: "Does it ______ long?", options: ["take", "spend", "cost"], ans: "take", hint: "It 當主詞，用 take。" },
                { q: "It ______ her 5 years to finish the book.", options: ["took", "spent", "paid"], ans: "took", hint: "It took..." },
                { q: "Do you ______ much time on your phone?", options: ["spend", "take", "cost"], ans: "spend", hint: "人 spend time on..." },
                { q: "It ______ 20 minutes to drive there.", options: ["takes", "spends", "costs"], ans: "takes", hint: "It takes..." },
                { q: "They ______ the weekend camping.", options: ["spent", "took", "cost"], ans: "spent", hint: "人 spent 時間 V-ing (camping)。" },
                { q: "How much time did you ______?", options: ["spend", "take", "cost"], ans: "spend", hint: "人 did you spend?" },
                { q: "It will ______ a long time.", options: ["take", "spend", "pay"], ans: "take", hint: "It will take..." },
                { q: "I ______ 10 minutes waiting for the bus.", options: ["spent", "took", "cost"], ans: "spent", hint: "人 spent 時間 V-ing。" },
                { q: "It ______ two hours to fly to Japan.", options: ["takes", "spends", "costs"], ans: "takes", hint: "It takes..." },
                { q: "He ______ his free time reading.", options: ["spends", "takes", "costs"], ans: "spends", hint: "人 spends 時間 V-ing。" },
                { q: "Did it ______ you a long time?", options: ["take", "spend", "cost"], ans: "take", hint: "Did it take you...?" },
                { q: "Don't ______ time playing games.", options: ["spend", "take", "cost"], ans: "spend", hint: "人 spend time V-ing。" },
                { q: "It ______ only a few seconds.", options: ["takes", "spends", "costs"], ans: "takes", hint: "It takes..." },
                { q: "She ______ all night studying.", options: ["spent", "took", "cost"], ans: "spent", hint: "人 spent 時間 V-ing。" },
                { q: "How long does it ______?", options: ["take", "spend", "cost"], ans: "take", hint: "It 當主詞用 take。" },
                { q: "It ______ me an hour to fix it.", options: ["took", "spent", "paid"], ans: "took", hint: "It took me..." }
            ];
            return shuffleArray(pool);
        };

        // --- Unit 6 重組生成器 (改為使用新單字例句) ---
        const generateUnit6ScramblePool = (vocabData) => {
             // 自動從 Vocab Data 生成重組題目
            if (!vocabData) return [];
            return vocabData.map((item, index) => ({
                id: `u6-sc-${index}`,
                sentence: item.sentence.replace(/A: |B: /g, ''), // 移除對話標籤 A: B: 避免混淆
                sentence_ch: item.sentence_ch.replace(/A: |B: /g, '')
            }));
        };

        // --- Unit 5 單字資料 ---
        const unit5VocabData = [
            { id: "u5-1", word: "metro", part: "n.", chinese: "捷運", sentence: "You can go there by bus or metro.", sentence_ch: "你可以搭公車或捷運去那裡。" },
            { id: "u5-2", word: "lost", part: "adj.", chinese: "迷路的", sentence: "I got lost on the way to the train station.", sentence_ch: "我在去火車站的路上迷路了。" },
            { id: "u5-3", word: "map", part: "n.", chinese: "地圖", sentence: "We are lost. We need a map now.", sentence_ch: "我們迷路了。我們現在需要地圖。" },
            { id: "u5-4", word: "ask", part: "v.", chinese: "請求；詢問", sentence: "You can ask your friends to help you.", sentence_ch: "你可以請求你的朋友幫你。" },
            { id: "u5-5", word: "Excuse me", part: "phr.", chinese: "對不起；請問...", sentence: "Excuse me. Where is the bathroom?", sentence_ch: "不好意思。請問廁所在哪裡？" },
            { id: "u5-6", word: "straight", part: "adv.; adj.", chinese: "直地；直的", sentence: "Turn right at the hospital and keep going straight.", sentence_ch: "在醫院右轉並繼續直走。" },
            { id: "u5-7", word: "turn left", part: "phr.", chinese: "向左轉", sentence: "Turn left on First Street, and the shop is on the corner.", sentence_ch: "在第一街左轉，商店就在轉角處。" },
            { id: "u5-8", word: "along", part: "prep.", chinese: "沿著", sentence: "There are many flowers along the river.", sentence_ch: "沿著河邊有很多花。" },
            { id: "u5-9", word: "block", part: "n.", chinese: "街區", sentence: "My good friend and I live on the same block.", sentence_ch: "我的好朋友和我住在同一個街區。" },
            { id: "u5-10", word: "corner", part: "n.", chinese: "轉角；角落", sentence: "Jackie's house is on the corner of Apple Street and Cherry Road.", sentence_ch: "Jackie的家在Apple Street和Cherry Road的轉角。" },
            { id: "u5-11", word: "across from", part: "phr.", chinese: "在...的對面", sentence: "Stacy is sitting across from Justin and Alex.", sentence_ch: "Stacy正坐在Justin和Alex的對面。" },
            { id: "u5-12", word: "supermarket", part: "n.", chinese: "超市", sentence: "Gina goes to the supermarket every Saturday.", sentence_ch: "Gina每個星期六都去超市。" },
            { id: "u5-13", word: "ground", part: "n.", chinese: "地面", sentence: "Be careful! There is a bug on the ground.", sentence_ch: "小心！地上有一隻蟲。" },
            { id: "u5-14", word: "sir", part: "n.", chinese: "先生", sentence: "Good morning, sir. May I help you?", sentence_ch: "早安，先生。我可以幫你嗎？" },
            { id: "u5-15", word: "on foot", part: "phr.", chinese: "步行", sentence: "The flower shop is close. Let's go there on foot.", sentence_ch: "花店很近。我們走路去那裡吧。" },
            { id: "u5-16", word: "take", part: "v.", chinese: "搭乘 (交通工具)", sentence: "We can take a taxi or a bus, but not the metro.", sentence_ch: "我們可以搭計程車或公車，但不能搭捷運。" },
            { id: "u5-32", word: "go jogging", part: "phr.", chinese: "慢跑", sentence: "He goes jogging in the morning before he goes to work.", sentence_ch: "他在上班前會去慢跑。" },
            { id: "u5-33", word: "go sailing", part: "phr.", chinese: "玩帆船；航行", sentence: "Let's go sailing in August during summer vacation.", sentence_ch: "讓我們在暑假的八月去玩帆船吧。" },
            { id: "u5-34", word: "go surfing", part: "phr.", chinese: "衝浪", sentence: "Did you often go surfing with your friend?", sentence_ch: "你經常和你的朋友去衝浪嗎？" },
            { id: "u5-35", word: "fly", part: "v.", chinese: "飛行；駕駛", sentence: "My uncle can fly a plane.", sentence_ch: "我的叔叔會開飛機。" },
            { id: "u5-36", word: "bus stop", part: "n.", chinese: "公車站", sentence: "Let's wait for Alice at the bus stop.", sentence_ch: "讓我們在公車站等Alice。" },
            { id: "u5-37", word: "go biking", part: "phr.", chinese: "騎單車", sentence: "Many people like to go biking at the park.", sentence_ch: "許多人喜歡在公園騎單車。" },
            { id: "u5-38", word: "go shopping", part: "phr.", chinese: "購物", sentence: "They want to go shopping for clothes this afternoon.", sentence_ch: "他們今天下午想去買衣服。" },
            { id: "u5-39", word: "hit", part: "v.; n.", chinese: "碰撞；打擊", sentence: "The man was using his phone when his car hit the tree.", sentence_ch: "當車子撞到樹時，那個人正在用手機。" },
            { id: "u5-40", word: "sound", part: "n.", chinese: "聲音", sentence: "What is that strange sound? Oh, it's our dog.", sentence_ch: "那奇怪的聲音是什麼？喔，是我們的狗。" },
            { id: "u5-41", word: "bell", part: "n.", chinese: "鐘；鈴", sentence: "Do you have a bell on your bicycle?", sentence_ch: "你的腳踏車上有鈴鐺嗎？" },
            { id: "u5-42", word: "experience", part: "n.; v.", chinese: "經歷；經驗", sentence: "People learn from their past experience.", sentence_ch: "人們從過去的經驗中學習。" },
            { id: "u5-43", word: "wonderful", part: "adj.", chinese: "美好的", sentence: "I had a wonderful time at the party yesterday.", sentence_ch: "我昨天在派對上玩得很開心。" },
            { id: "u5-44", word: "play", part: "n.", chinese: "戲劇", sentence: "How many plays did William Shakespeare write?", sentence_ch: "威廉·莎士比亞寫了多少部戲劇？" },
            { id: "u5-45", word: "around", part: "adv.", chinese: "大約", sentence: "Brandon got home around nine thirty last night.", sentence_ch: "Brandon昨晚大約九點半回到家。" }
        ];

        // --- 新增：Unit 6 單字資料 ---
        const unit6VocabData = [
            { id: "u6-1", word: "will", part: "aux.", chinese: "將", sentence: "I will be late for class today.", sentence_ch: "我今天上課將會遲到。" },
            { id: "u6-2", word: "ugly", part: "adj.", chinese: "醜的", sentence: "This pair of shoes is ugly.", sentence_ch: "這雙鞋子很醜。" },
            { id: "u6-3", word: "sweater", part: "n.", chinese: "毛衣", sentence: "My favorite sweater is the pink one.", sentence_ch: "我最喜歡的毛衣是粉紅色的那件。" },
            { id: "u6-4", word: "tonight", part: "adv.; n.", chinese: "今晚", sentence: "Let's go to the baseball game tonight.", sentence_ch: "我們今晚去看棒球賽吧。" },
            { id: "u6-5", word: "funny", part: "adj.", chinese: "滑稽的", sentence: "Ted made a funny face.", sentence_ch: "Ted 做了一個滑稽的鬼臉。" },
            { id: "u6-6", word: "cost", part: "v.; n.", chinese: "價錢為；花費", sentence: "The belt cost me 500 NT dollars.", sentence_ch: "這條皮帶花了我五百元台幣。" },
            { id: "u6-7", word: "price", part: "n.", chinese: "價格", sentence: "What is the price of the popcorn?", sentence_ch: "爆米花的價格是多少？" },
            { id: "u6-8", word: "spend", part: "v.", chinese: "花費 (時間、金錢)", sentence: "I spend a lot of time at home.", sentence_ch: "我在家花了很多時間。" },
            { id: "u6-9", word: "expensive", part: "adj.", chinese: "昂貴的", sentence: "The guitar is too expensive. I don't have that much money.", sentence_ch: "這把吉他太貴了。我沒有那麼多錢。" },
            { id: "u6-10", word: "on sale", part: "phr.", chinese: "特價中", sentence: "These notebooks are on sale now. They are only 10 dollars each.", sentence_ch: "這些筆記本現在特價中。每本只要10元。" },
            { id: "u6-11", word: "pair", part: "n.", chinese: "(一)雙；(一)對", sentence: "Evans wants to buy a new pair of running shoes.", sentence_ch: "Evans 想要買一雙新的慢跑鞋。" },
            { id: "u6-12", word: "total", part: "n.; adj.", chinese: "總計 (的)；全部 (的)", sentence: "The total number of horses on the farm is 12.", sentence_ch: "農場裡的馬總數是十二隻。" },
            { id: "u6-13", word: "pay", part: "v.; n.", chinese: "付費；工資", sentence: "I will pay you back tomorrow.", sentence_ch: "我明天會還你錢。" },
            { id: "u6-14", word: "thousand", part: "n.", chinese: "千", sentence: "There are about two thousand students in the school.", sentence_ch: "學校裡大約有兩千名學生。" },
            { id: "u6-15", word: "tomorrow", part: "adv.; n.", chinese: "明天", sentence: "Bella is coming to my house tomorrow.", sentence_ch: "Bella 明天要來我家。" },
            { id: "u6-16", word: "high", part: "adj.", chinese: "高的", sentence: "What animals live in high mountains?", sentence_ch: "什麼動物住在高山上？" },
            { id: "u6-17", word: "save", part: "v.", chinese: "節省", sentence: "We can save time by taking the bus.", sentence_ch: "我們可以搭公車節省時間。" },
            { id: "u6-18", word: "would like", part: "phr.", chinese: "想要", sentence: "I would like to have some cookies with tea.", sentence_ch: "我想要吃些餅乾配茶。" },
            { id: "u6-19", word: "change", part: "n.", chinese: "找零", sentence: "Here is your change.", sentence_ch: "這是你的找零。" },
            { id: "u6-20", word: "take", part: "v.", chinese: "花費 (時間)", sentence: "It took me half an hour to clean up the room.", sentence_ch: "打掃房間花了我半小時。" },
            { id: "u6-38", word: "fast", part: "adj.; adv.", chinese: "快的；快地", sentence: "Thomas is a fast swimmer.", sentence_ch: "Thomas 是個游泳很快的人。" },
            { id: "u6-39", word: "low", part: "adj.", chinese: "低的", sentence: "The water in the river is low in summer.", sentence_ch: "夏天河裡的水位很低。" },
            { id: "u6-40", word: "cheap", part: "adj.", chinese: "便宜的", sentence: "The shop sells cheap bags. Let's take a look.", sentence_ch: "這家店賣便宜的包包。我們去看看吧。" },
            { id: "u6-41", word: "what's more", part: "phr.", chinese: "而且", sentence: "Lily is good at dancing, and what's more, her paintings are beautiful.", sentence_ch: "Lily 擅長跳舞，而且，她的畫也很美。" },
            { id: "u6-42", word: "most", part: "adj.", chinese: "大部分的", sentence: "Most people in the country love watching soccer games.", sentence_ch: "這個國家大部分的人喜歡看足球賽。" },
            { id: "u6-43", word: "hurt", part: "v.", chinese: "傷害", sentence: "I was riding my bike when I hurt my leg.", sentence_ch: "當我弄傷我的腿時，我正在騎腳踏車。" },
            { id: "u6-44", word: "come off", part: "phr.", chinese: "從...脫落", sentence: "Why is the paint coming off the walls?", sentence_ch: "為什麼牆上的油漆正在剝落？" },
            { id: "u6-45", word: "second", part: "n.", chinese: "秒", sentence: "Can you please give me a second?", sentence_ch: "可以請你給我一秒鐘（等我一下）嗎？" }
        ];

        // --- 資料庫 (在此處定義，確保前面的生成函式已存在) ---
        const UNITS_DATA = {
            unitCardinals: {
                title: "數字",
                vocab: generateNumberVocab(),
                grammar: {
                    notes: [
                        { title: "1. 基數 (Cardinal Numbers)", rule: "one, two, three...", desc: "用來表示數量。注意 40 是 forty (沒有 u)，100 是 one hundred。", examples: ["I have three apples."] },
                        { title: "2. 複合數字 (21-99)", rule: "十位數-個位數", desc: "21到99之間的數字，十位數和個位數之間通常會加連字號 (-)。", examples: ["twenty-one (21)"] }
                    ],
                    quiz: generateNumberQuizPool(),
                    scramble: generateNumberScramblePool()
                }
            },
            unitOrdinals: {
                title: "序列",
                vocab: generateOrdinalVocab(),
                grammar: {
                    notes: [
                        { title: "1. 序數 (Ordinal Numbers)", rule: "first, second, third...", desc: "用來表示順序、日期或樓層。通常在基數後面加 th，但有不規則變化。", examples: ["It is the first day.", "She is on the second floor."] },
                        { title: "2. 不規則變化 (Irregular)", rule: "1st, 2nd, 3rd, 5th, 9th, 12th", desc: "one->first, two->second, three->third, five->fifth, nine->ninth, twelve->twelfth。", examples: ["My birthday is on May fifth."] },
                        { title: "3. 複合序數 (21st, 32nd...)", rule: "只變最後一個字", desc: "例如 21 變成 twenty-first，不是 twentieth-first。", examples: ["It is the twenty-first century."] },
                        { title: "4. 整十的序數 (20th, 30th...)", rule: "ty -> tieth", desc: "例如 twenty -> twentieth, thirty -> thirtieth。", examples: ["It is his twentieth birthday."] }
                    ],
                    quiz: generateOrdinalQuizPool(),
                    scramble: generateOrdinalScramblePool()
                }
            },
            unit5: {
                title: "Unit 5",
                vocab: unit5VocabData,
                grammar: {
                    tips: [
                        { label: "by + 交通工具", text: "by bus, by car (中間不能加 a/the)" },
                        { label: "on foot", text: "走路固定用法 (不能說 by foot)" },
                        { label: "take + a + 交通工具", text: "take a bus, take a taxi (take 是動詞，要有 a)" },
                        { label: "How vs Where", text: "問「交通方式」用 How；問「地點」用 Where" }
                    ],
                    notes: [
                        { 
                            title: "1. 詢問與描述交通方式 (Transportation)", 
                            rule: "詢問: How + do/did... / 描述: 動詞 (take/ride) vs 介系詞 (by)", 
                            desc: "動詞用法通常加冠詞 (take a taxi)；介系詞用法直接接交通工具 (by taxi)。走路固定用 on foot。", 
                            examples: ["How do the workers go home?", "She takes a train.", "We go there by metro.", "I go to school on foot."] 
                        },
                        { 
                            title: "2. 詢問與指引方向 (Asking & Giving Directions)", 
                            rule: "How do I get to...? / Go straight, Turn left/right", 
                            desc: "詢問路徑用 get to。指引方向使用原形動詞開頭的祈使句：直走 (Go straight)、沿著走 (Walk along)、轉彎 (Turn right/left)。", 
                            examples: ["How do we get to Green Park?", "Go straight for two blocks.", "Walk down this road.", "Turn right at the police station."] 
                        },
                        { 
                            title: "3. 方位介系詞 (Prepositions of Place)", 
                            rule: "between, across from, on the corner of, next to, on", 
                            desc: "用來描述建築物位置。between A and B (在...之間)、across from (在...對面)、on the corner of (在...轉角)、next to (在...旁邊)、on (在...路上)。", 
                            examples: ["The bank is between the hotel and the fire station.", "The post office is across from the hospital.", "The hospital is on the corner of Spring Road.", "The post office is on Spring Road."] 
                        }
                    ],
                    quiz: generateUnit5QuizPool(),
                    scramble: generateUnit5ScramblePool(unit5VocabData) // 使用新的生成器，傳入單字資料
                }
            },
            unit6: {
                title: "Unit 6",
                vocab: unit6VocabData,
                grammar: {
                    tips: [
                        { label: "看到時間詞", text: "tomorrow, next week → 用未來式 will 或 be going to" },
                        { label: "will 後面", text: "一定要接原形動詞 (VR)" },
                        { label: "主詞是「人」", text: "花錢/時間用 spend (spend ... V-ing / on 物品)" },
                        { label: "主詞是「物」", text: "花錢用 cost (The bag costs $100)" },
                        { label: "主詞是「It」", text: "花時間用 takes (It takes ... to V)" }
                    ],
                    notes: [
                        { title: "1. 未來式 (Future Tense) - will", rule: "S + will / won't + V_root", desc: "表達未來將發生的動作。", examples: ["I will wear a sweater.", "He won't go camping.", "Will you go? Yes, I will."] },
                        { title: "2. 未來式 (Future Tense) - be going to", rule: "S + am/is/are going to + V_root", desc: "詢問或描述具體的未來計畫。", examples: ["What is Pam going to do?", "She is going to practice the guitar."] },
                        { 
                            title: "3. 花費「金錢」 (cost / spend / pay)", 
                            rule: "物 cost 錢; 人 spend 錢 on 物; 人 pay 錢 for 物", 
                            desc: "主詞不同，動詞就不同。Cost 主詞是物品(金錢)；Spend/Pay 主詞是人。", 
                            examples: ["The sweater cost NT$1,000.", "She spent NT$1,000 on the sweater.", "She paid NT$1,000 for the sweater."] 
                        },
                        { 
                            title: "4. 花費「時間」 - It takes", 
                            rule: "It takes/took (+ 人) + 時間 + to V", 
                            desc: "使用虛主詞 It 開頭，後面的動詞必須用不定詞 (to V)。", 
                            examples: ["It took them three hours to drive to the park."] 
                        },
                        { 
                            title: "5. 花費「時間」 - Person spends", 
                            rule: "人 + spend + 時間 + V-ing", 
                            desc: "使用人當主詞時，後面的動作必須用動名詞 (V-ing)。", 
                            examples: ["They spent three hours driving to the park."] 
                        }
                    ],
                    quiz: generateUnit6QuizPool(),
                    scramble: generateUnit6ScramblePool(unit6VocabData)
                }
            }
        };

        // --- GameButton Component (Defined before use) ---
        const GameButton = ({ children, onClick, color = "blue", className = "", disabled = false, active = false }) => {
            const colorStyles = {
                blue: "bg-sky-400 border-sky-600 text-white hover:bg-sky-300",
                green: "bg-emerald-400 border-emerald-600 text-white hover:bg-emerald-300",
                yellow: "bg-yellow-400 border-yellow-600 text-yellow-900 hover:bg-yellow-300",
                red: "bg-rose-400 border-rose-600 text-white hover:bg-rose-300",
                purple: "bg-violet-400 border-violet-600 text-white hover:bg-violet-300",
                white: "bg-white border-slate-200 text-slate-700 hover:bg-slate-50",
                gray: "bg-slate-200 border-slate-400 text-slate-600 hover:bg-slate-300",
                active: "bg-yellow-400 border-yellow-600 text-yellow-900 ring-2 ring-yellow-200 ring-offset-2",
            };
            const finalColor = active ? colorStyles.active : (colorStyles[color] || colorStyles.blue);
            return (
                <button
                onClick={onClick}
                disabled={disabled}
                className={`
                    ${finalColor} 
                    border-b-4 active:border-b-0 active:translate-y-1 
                    rounded-2xl px-4 py-2 font-black tracking-wide 
                    transition-all duration-100 shadow-md 
                    flex items-center justify-center gap-2
                    disabled:opacity-50 disabled:cursor-not-allowed disabled:active:border-b-4 disabled:active:translate-y-0
                    ${className}
                `}
                >
                {children}
                </button>
            );
        };

        // --- 元件 1: 單字學習模式 ---
        const StudyMode = ({ data }) => {
            const [mode, setMode] = useState('card');
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);

            useEffect(() => {
                setCurrentIndex(0);
                setIsFlipped(false);
            }, [data]);

            if (!data || data.length === 0) return <div className="p-10 text-center text-slate-400 font-bold">目前沒有資料</div>;

            const currentWord = data[currentIndex];
            const handleNext = () => { setIsFlipped(false); setTimeout(() => setCurrentIndex((prev) => (prev + 1) % data.length), 200); };
            const handlePrev = () => { setIsFlipped(false); setTimeout(() => setCurrentIndex((prev) => (prev - 1 + data.length) % data.length), 200); };

            return (
                <div className="flex flex-col h-full animate-in fade-in">
                    <div className="flex justify-center mb-6 gap-3">
                        <GameButton onClick={() => setMode('card')} active={mode === 'card'} color="white" className="text-sm"><Layers className="w-4 h-4" /> 卡牌</GameButton>
                        <GameButton onClick={() => setMode('list')} active={mode === 'list'} color="white" className="text-sm"><LayoutList className="w-4 h-4" /> 列表</GameButton>
                    </div>

                    {mode === 'card' ? (
                        <div className="flex-1 flex flex-col items-center justify-start min-h-[400px]">
                            <div 
                                className="relative w-full max-w-sm h-80 cursor-pointer group perspective-1000 z-10"
                                onClick={() => setIsFlipped(!isFlipped)}
                                style={{ perspective: '1000px' }}
                            >
                                <div 
                                    className="relative w-full h-full transition-transform duration-500"
                                    style={{ transformStyle: 'preserve-3d', transform: isFlipped ? 'rotateY(180deg)' : 'rotateY(0deg)' }}
                                >
                                    <div className="absolute inset-0 bg-white border-4 border-sky-400 rounded-3xl shadow-[0_8px_0_rgba(56,189,248,0.3)] flex flex-col items-center justify-center p-6" style={{ backfaceVisibility: 'hidden', WebkitBackfaceVisibility: 'hidden' }}>
                                        <div className="absolute top-4 right-6 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-sm font-black border-2 border-yellow-600 shadow-sm rotate-3">{currentIndex + 1} / {data.length}</div>
                                        <h2 className="text-3xl sm:text-4xl font-black text-slate-800 mb-2 tracking-tight text-center break-words w-full drop-shadow-sm">{currentWord.word}</h2>
                                        <span className="text-white bg-sky-500 font-bold px-4 py-1.5 rounded-xl text-lg shadow-md border-b-4 border-sky-700 transform -rotate-2">{currentWord.part}</span>
                                        <div className="mt-10 text-slate-400 text-xs font-bold flex items-center gap-1 animate-pulse bg-slate-100 px-3 py-1 rounded-full"><RefreshCw className="w-3 h-3" /> CLICK TO FLIP</div>
                                        <button onClick={(e) => { e.stopPropagation(); speakText(currentWord.word); }} className="absolute bottom-5 right-1/2 translate-x-1/2 p-3 bg-rose-400 text-white rounded-full border-b-4 border-rose-600 active:border-b-0 active:translate-y-1 transition-all shadow-md"><Volume2 className="w-6 h-6" /></button>
                                    </div>
                                    <div className="absolute inset-0 bg-violet-500 border-4 border-violet-700 text-white rounded-3xl shadow-[0_8px_0_rgba(109,40,217,0.3)] flex flex-col items-center justify-center p-8" style={{ backfaceVisibility: 'hidden', WebkitBackfaceVisibility: 'hidden', transform: 'rotateY(180deg)' }}>
                                        <h3 className="text-2xl sm:text-3xl font-black mb-4 text-center leading-snug drop-shadow-md bg-white/20 px-4 py-2 rounded-xl backdrop-blur-sm border-2 border-white/30 transform -rotate-1">{currentWord.chinese}</h3>
                                        <div className="bg-black/20 p-4 rounded-xl border-2 border-white/10 w-full relative overflow-y-auto max-h-[140px]">
                                            <p className="text-white text-center italic text-sm sm:text-base leading-relaxed font-bold">"{currentWord.sentence}"</p>
                                            <p className="text-violet-200 text-center text-xs mt-2 font-medium">{currentWord.sentence_ch}</p>
                                        </div>
                                        <button onClick={(e) => { e.stopPropagation(); speakText(currentWord.sentence); }} className="mt-4 p-3 bg-yellow-400 text-yellow-900 rounded-full border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1 transition-all shadow-md"><Volume2 className="w-5 h-5" /></button>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-4 mt-8 w-full max-w-sm px-4">
                                <GameButton onClick={handlePrev} color="white" className="flex-1"><ChevronLeft className="w-6 h-6" /> 上一個</GameButton>
                                <GameButton onClick={handleNext} color="blue" className="flex-1 text-lg">下一個 <ChevronRight className="w-6 h-6" /></GameButton>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 overflow-y-auto max-h-[70vh] pr-1 space-y-3 pb-20">
                            {data.map((item) => (
                                <div key={item.id} className="bg-white p-4 rounded-2xl border-b-4 border-slate-200 flex items-center justify-between hover:translate-x-1 transition-all group">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="font-black text-lg text-slate-700 group-hover:text-sky-500 transition-colors">{item.word}</span>
                                            <span className="text-xs text-white bg-slate-400 px-2 py-0.5 rounded-lg font-bold border-b-2 border-slate-600">{item.part}</span>
                                        </div>
                                        <div className="text-slate-500 text-sm font-bold">{item.chinese}</div>
                                    </div>
                                    <button onClick={() => speakText(item.word)} className="p-2 bg-sky-100 text-sky-500 rounded-xl hover:bg-sky-200 active:scale-95 transition-colors"><Volume2 className="w-5 h-5" /></button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- 元件 2.1: 拼字測驗 (修正版: 新增提示與查看答案) ---
        const SpellingQuiz = ({ data, onFinish }) => {
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [quizItems, setQuizItems] = useState([]);
            const [currentLetters, setCurrentLetters] = useState([]); 
            const [poolLetters, setPoolLetters] = useState([]); 
            const [feedback, setFeedback] = useState(null); 
            const [score, setScore] = useState(0);
            const [targetPattern, setTargetPattern] = useState([]); 
            const [targetClean, setTargetClean] = useState([]); 

            useEffect(() => {
                if (!data || data.length === 0) return;
                const shuffled = shuffleArray([...data]).slice(0, 10);
                setQuizItems(shuffled);
                setCurrentQIndex(0);
                setScore(0);
                if (shuffled.length > 0) loadQuestion(shuffled[0]);
            }, [data]);

            const loadQuestion = (item) => {
                if(!item) return;
                const rawWord = item.word.toLowerCase();
                setTargetPattern(rawWord.split(''));
                const cleanChars = rawWord.replace(/[^a-z]/g, '').split('');
                setTargetClean(cleanChars);
                
                const scrambled = cleanChars.map((char, idx) => ({ char, id: idx, key: `${char}-${idx}-${Math.random()}` }));
                setPoolLetters(shuffleArray([...scrambled]));
                setCurrentLetters([]);
                setFeedback(null);
                speakText(item.word);
            };

            const handlePoolClick = (l) => { if (feedback === 'correct') return; setPoolLetters(prev => prev.filter(p => p.key !== l.key)); setCurrentLetters(prev => [...prev, l]); };
            const handleAnswerClick = (l) => { if (feedback === 'correct') return; setCurrentLetters(prev => prev.filter(p => p.key !== l.key)); setPoolLetters(prev => [...prev, l]); };

            const handleHint = () => {
                if (feedback === 'correct') return;
                const nextCharIndex = currentLetters.length;
                if (nextCharIndex >= targetClean.length) return; 

                const neededChar = targetClean[nextCharIndex];
                const candidate = poolLetters.find(l => l.char === neededChar);
                if (candidate) {
                    handlePoolClick(candidate);
                }
            };

            const handleSolve = () => {
                if (feedback === 'correct') return;
                
                let tempPool = [...poolLetters, ...currentLetters];
                const solution = [];
                const remainingPool = [...tempPool];

                for (const char of targetClean) {
                    const foundIndex = remainingPool.findIndex(l => l.char === char);
                    if (foundIndex !== -1) {
                        solution.push(remainingPool[foundIndex]);
                        remainingPool.splice(foundIndex, 1);
                    }
                }

                setCurrentLetters(solution);
                setPoolLetters(remainingPool);
            };

            const checkAnswer = () => {
                if (feedback === 'correct') return;

                const currentItem = quizItems[currentQIndex];
                if (!currentItem) return;
                const targetWord = currentItem.word.toLowerCase().replace(/[^a-z]/g, '');
                const userWord = currentLetters.map(l => l.char).join('');
                if (userWord === targetWord) {
                    setFeedback('correct');
                    speakText("Correct! " + currentItem.word);
                    setScore(prev => prev + 10);
                    setTimeout(handleNext, 1500);
                } else {
                    setFeedback('wrong');
                    speakText("Try again");
                    setTimeout(() => setFeedback(null), 1000);
                }
            };

            const handleNext = () => {
                if (currentQIndex < quizItems.length - 1) {
                    const nextIndex = currentQIndex + 1;
                    setCurrentQIndex(nextIndex);
                    loadQuestion(quizItems[nextIndex]);
                } else {
                    onFinish(score + (feedback === 'correct' ? 10 : 0));
                }
            };

            if (!quizItems || quizItems.length === 0) return <div className="p-10 text-center text-slate-400 font-bold">載入中或無資料...</div>;
            const currentItem = quizItems[currentQIndex];
            if (!currentItem) return null;
            let letterIndex = 0;

            return (
                <div className="flex flex-col items-center">
                    <div className="w-full flex justify-between items-center mb-4 px-2">
                         <span className="text-xs font-black text-slate-400">SPELLING {currentQIndex + 1} / {quizItems.length}</span>
                         <span className="text-xs font-black text-yellow-600 bg-yellow-100 px-2 py-1 rounded-lg">SCORE: {score}</span>
                    </div>
                    <div className="bg-white border-4 border-b-8 border-violet-200 rounded-3xl p-8 mb-6 text-center w-full relative shadow-sm">
                        <div className="absolute top-3 left-1/2 -translate-x-1/2 bg-violet-100 text-violet-600 px-3 py-1 rounded-lg text-xs font-black uppercase tracking-wider">Listen & Spell</div>
                        <h2 className="font-black text-3xl text-slate-800 mt-4 mb-2">{currentItem.chinese}</h2>
                        <button onClick={() => speakText(currentItem.word)} className="p-4 bg-sky-100 text-sky-500 rounded-full hover:bg-sky-200 active:scale-95 transition-colors border-4 border-sky-200"><Volume2 className="w-8 h-8" /></button>
                        <p className="mt-2 text-slate-400 text-xs font-bold">點擊喇叭聽發音</p>
                    </div>
                    <div className="relative flex flex-wrap justify-center items-end gap-2 min-h-[80px] mb-6 p-4 bg-slate-200 rounded-3xl w-full border-inner border-4 border-slate-300">
                        {targetPattern.map((char, idx) => {
                            if (/[a-z]/.test(char)) {
                                const filledLetter = currentLetters[letterIndex];
                                letterIndex++;
                                return filledLetter ? (
                                    <button key={`filled-${idx}`} onClick={() => handleAnswerClick(filledLetter)} className="w-10 h-12 bg-indigo-500 text-white rounded-lg font-black text-2xl shadow-[0_4px_0_rgb(55,48,163)] active:translate-y-1 active:shadow-none transition-all pop-in mx-[1px]">{filledLetter.char}</button>
                                ) : <div key={`empty-${idx}`} className="w-10 h-12 bg-white/50 rounded-lg border-b-4 border-slate-300 mx-[1px]"></div>;
                            } else if (char === ' ') {
                                return <div key={`space-${idx}`} className="w-6 h-12 flex items-center justify-center"></div>;
                            } else {
                                return <div key={`symbol-${idx}`} className="w-6 h-12 flex items-end justify-center pb-2 text-slate-400 font-black text-xl">{char}</div>;
                            }
                        })}
                        {currentLetters.length === 0 && <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-50"><span className="text-slate-500 font-bold text-sm bg-slate-200/80 px-2 py-1 rounded">點擊下方字母拼字</span></div>}
                    </div>
                    <div className="flex flex-wrap justify-center gap-3 mb-8">
                        {poolLetters.map((l) => (
                             <button key={l.key} onClick={() => handlePoolClick(l)} className="w-12 h-14 bg-white text-slate-700 border-b-4 border-slate-300 rounded-xl font-black text-2xl shadow-sm hover:bg-slate-50 active:border-b-0 active:translate-y-1 transition-all">{l.char}</button>
                        ))}
                    </div>
                    <div className={`w-full transition-all duration-300 flex flex-col gap-2 ${feedback === 'wrong' ? 'animate-shake' : ''}`}>
                         <div className="flex gap-2 w-full">
                            <GameButton onClick={handleHint} color="yellow" className="flex-1 text-sm py-3" disabled={feedback === 'correct'}>
                                <Lightbulb className="w-4 h-4" /> 💡 提示一字
                            </GameButton>
                            <GameButton onClick={handleSolve} color="red" className="flex-1 text-sm py-3" disabled={feedback === 'correct'}>
                                <Eye className="w-4 h-4" /> 👀 查看答案
                            </GameButton>
                         </div>

                         <GameButton onClick={checkAnswer} color={feedback === 'correct' ? 'green' : (feedback === 'wrong' ? 'red' : 'blue')} className="w-full py-4 text-xl" disabled={currentLetters.length === 0}>
                            {feedback === 'correct' ? <><CheckCircle /> Correct!</> : (feedback === 'wrong' ? <><XCircle /> Wrong!</> : "Check Answer")}
                        </GameButton>
                    </div>
                </div>
            );
        };

        // --- 元件 3: 重組句子模式 (積木風格) ---
        const ScrambleMode = ({ data, titleOverride }) => {
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [showResult, setShowResult] = useState(false);
            const [userSentence, setUserSentence] = useState([]); 
            const [availableWords, setAvailableWords] = useState([]); 
            const [feedback, setFeedback] = useState(null); 
            const [showGiveUpConfirm, setShowGiveUpConfirm] = useState(false); 
            const [showHelperHint, setShowHelperHint] = useState(false); 

            useEffect(() => { resetGame(); }, [data]);
        
            const resetGame = () => {
                if (!data || data.length === 0) return;
                const count = 5; // 每次只出 5 題
                const shuffledQuestions = shuffleArray([...data]).slice(0, count); 
                setQuestions(shuffledQuestions);
                setCurrentIndex(0);
                setScore(0);
                setShowResult(false);
                if(shuffledQuestions.length > 0) loadQuestion(shuffledQuestions[0]);
            };
        
            const loadQuestion = (question) => {
                if (!question) return;
                const rawSentence = question.sentence;
                const spacedSentence = rawSentence.replace(/([.!?])$/, ' $1');
                const words = spacedSentence.split(' ');
                const wordsWithIds = words.map((word, index) => ({ id: `${index}-${word}`, text: word }));
                setAvailableWords(shuffleArray(wordsWithIds));
                setUserSentence([]);
                setFeedback(null);
                setShowGiveUpConfirm(false);
                setShowHelperHint(false);
            };
        
            const handleSkipQuestion = () => {
                if (questions.length <= 1) return; 
                const currentQuestionIds = questions.map(q => q.id);
                const candidates = data.filter(item => !currentQuestionIds.includes(item.id));
                let newQuestion;
                if (candidates.length > 0) {
                    newQuestion = candidates[Math.floor(Math.random() * candidates.length)];
                } else {
                    const otherQuestions = data.filter(item => item.id !== questions[currentIndex].id);
                    newQuestion = otherQuestions[Math.floor(Math.random() * otherQuestions.length)];
                }
                const newQuestions = [...questions];
                newQuestions[currentIndex] = newQuestion;
                setQuestions(newQuestions);
                loadQuestion(newQuestion);
            };

            const handleWordClick = (wordObj) => { if (feedback === 'correct') return; if (feedback === 'wrong') setFeedback(null); setAvailableWords(prev => prev.filter(w => w.id !== wordObj.id)); setUserSentence(prev => [...prev, wordObj]); };
            const handleAnswerClick = (wordObj) => { if (feedback === 'correct') return; if (feedback === 'wrong') setFeedback(null); setUserSentence(prev => prev.filter(w => w.id !== wordObj.id)); setAvailableWords(prev => [...prev, wordObj]); };
            const handleTryAgain = () => { setFeedback(null); setShowHelperHint(true); setTimeout(() => setShowHelperHint(false), 5000); };
            const handleMagicHint = () => {
                if (feedback === 'correct') return;
                setFeedback(null); 
                let firstWrongIndex = -1;
                for (let i = 0; i < userSentence.length; i++) { if (!userSentence[i].id.startsWith(`${i}-`)) { firstWrongIndex = i; break; } }
                if (firstWrongIndex === -1) firstWrongIndex = userSentence.length;
                const totalWords = userSentence.length + availableWords.length;
                if (firstWrongIndex >= totalWords) return;
                const correctPart = userSentence.slice(0, firstWrongIndex);
                const wrongPart = userSentence.slice(firstWrongIndex);
                const targetIdPrefix = `${firstWrongIndex}-`;
                let nextWordObj = wrongPart.find(w => w.id.startsWith(targetIdPrefix));
                let newAvailable = [...newAvailable, ...others];
                if (nextWordObj) {
                    const others = wrongPart.filter(w => w.id !== nextWordObj.id);
                    newAvailable = [...newAvailable, ...others];
                } else {
                    nextWordObj = availableWords.find(w => w.id.startsWith(targetIdPrefix));
                    if (nextWordObj) {
                        newAvailable = newAvailable.filter(w => w.id !== nextWordObj.id);
                        newAvailable = [...newAvailable, ...wrongPart];
                    }
                }
                if (nextWordObj) {
                    setUserSentence([...correctPart, nextWordObj]);
                    setAvailableWords(newAvailable);
                    speakText(nextWordObj.text);
                }
            };

            const handleGiveUpClick = () => { setFeedback(null); setShowGiveUpConfirm(true); };
            const confirmGiveUp = () => {
                const allWords = [...userSentence, ...availableWords];
                allWords.sort((a, b) => { const indexA = parseInt(a.id.split('-')[0]); const indexB = parseInt(b.id.split('-')[0]); return indexA - indexB; });
                setUserSentence(allWords);
                setAvailableWords([]);
                setFeedback('correct'); 
                setShowGiveUpConfirm(false);
            };

            const checkAnswer = () => {
                const currentQuestion = questions[currentIndex];
                const targetSentence = currentQuestion.sentence.replace(/\s+([.!?])/g, '$1'); 
                const userRawString = userSentence.map(w => w.text).join(' ');
                const userCleanString = userRawString.replace(/\s+([.!?])/g, '$1');
                if (userCleanString === targetSentence) { 
                    // 1. 新增：防止重複點擊加分
                    if (feedback === 'correct') return;
                    setFeedback('correct'); 
                    setScore(prev => prev + 20); 
                    speakText(currentQuestion.sentence); 
                } else { 
                    setFeedback('wrong'); 
                    speakText("Oops"); 
                }
            };
            const nextQuestion = () => { if (currentIndex < questions.length - 1) { setCurrentIndex(prev => prev + 1); loadQuestion(questions[currentIndex + 1]); } else { setShowResult(true); } };

            if (!questions || questions.length === 0) return <div className="p-10 text-center font-bold text-slate-400">Loading or No Data...</div>;
            if (showResult) return (
                <div className="flex flex-col items-center justify-center h-full animate-in zoom-in py-10 relative overflow-hidden">
                    <Star className="w-32 h-32 text-yellow-400 mb-6 fill-yellow-400 drop-shadow-[0_4px_0_rgba(234,179,8,1)] animate-bounce" />
                    <h2 className="text-4xl font-black text-slate-800 mb-2 tracking-tight">挑戰成功！</h2>
                    <div className="text-7xl font-black text-indigo-600 mb-8 drop-shadow-sm">{score}</div>
                    <GameButton onClick={resetGame} color="purple" className="w-64 py-4 text-xl"><RefreshCw className="w-6 h-6" /> 再玩一次</GameButton>
                </div>
            );
        
            const currentQ = questions[currentIndex];
            return (
            <div className="flex flex-col h-full max-w-2xl mx-auto pb-24 relative">
                <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0 opacity-30"><div className="absolute top-10 left-10 text-yellow-300"><Star size={40} /></div><div className="absolute top-40 right-10 text-rose-300"><Puzzle size={50} /></div><div className="absolute bottom-20 left-20 text-sky-300"><Gamepad2 size={60} /></div></div>
                <div className="bg-white border-4 border-b-8 border-orange-200 rounded-3xl p-6 mb-6 text-center relative z-10 shadow-sm">
                    <div className="flex justify-between items-center mb-2">
                        <div className="inline-block bg-orange-100 text-orange-600 font-black px-3 py-1 rounded-lg text-xs border-2 border-orange-200">{titleOverride ? titleOverride : `LEVEL ${currentIndex + 1}`}</div>
                        {currentQ?.word && <div className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">Target: {currentQ.word}</div>}
                    </div>
                    <h2 className="font-black text-2xl text-slate-800 mb-4 leading-relaxed drop-shadow-sm">{currentQ?.sentence_ch}</h2>
                    <p className="text-orange-500 text-sm font-bold bg-orange-50 px-4 py-1.5 rounded-full inline-block border-2 border-orange-100 animate-pulse">請用下方的積木拼出這句英文</p>
                </div>
                <div className="bg-slate-200/50 rounded-3xl shadow-inner border-4 border-slate-300 min-h-[160px] p-5 mb-6 flex flex-wrap content-center justify-center gap-3 relative transition-all z-10">
                    {userSentence.length === 0 && <div className="text-slate-400 font-black pointer-events-none flex flex-col items-center"><Puzzle className="w-10 h-10 mb-2 opacity-50" />請依序點擊下方的英文單字</div>}
                    {userSentence.map((wordObj) => (<button key={wordObj.id} onClick={() => handleAnswerClick(wordObj)} className="bg-indigo-500 text-white px-4 py-3 rounded-xl font-bold shadow-[0_4px_0_rgb(55,48,163)] active:shadow-none active:translate-y-1 transition-all border-2 border-indigo-400 text-lg animate-in zoom-in">{wordObj.text}</button>))}
                </div>
                <div className="h-20 mb-4 flex items-center justify-center gap-3 z-10 relative">
                    {feedback === 'correct' ? (
                        <div className="w-full bg-emerald-100 border-4 border-emerald-300 text-emerald-700 px-6 py-4 rounded-3xl flex items-center justify-between shadow-lg animate-in slide-in-from-bottom-2">
                            <div className="flex items-center gap-2 font-black text-xl"><CheckCircle className="w-8 h-8 text-emerald-500" /> CORRECT!</div>
                            <GameButton onClick={nextQuestion} color="green" className="text-sm">NEXT <ChevronRight className="w-4 h-4" /></GameButton>
                        </div>
                    ) : feedback === 'wrong' ? (
                        <div className="w-full flex justify-center animate-in shake">
                            <button onClick={handleTryAgain} className="bg-rose-500 text-white border-b-4 border-rose-700 active:border-b-0 active:translate-y-1 px-8 py-3 rounded-2xl font-black text-xl shadow-xl flex items-center gap-2 hover:bg-rose-600 transition-all w-full justify-center"><XCircle className="w-8 h-8" /> TRY AGAIN! (點擊重試)</button>
                        </div>
                    ) : (
                        <>
                        <div className="flex gap-2 relative">
                                {showHelperHint && <div className="absolute -top-20 left-0 bg-white border-4 border-sky-400 p-3 rounded-2xl w-48 shadow-xl z-50 animate-in fade-in slide-in-from-bottom-2"><p className="text-sky-600 text-xs font-black mb-1">💡 卡關了嗎？</p><p className="text-slate-600 text-xs font-bold">試試左邊的魔法棒或投降旗幟喔！</p><div className="absolute -bottom-3 left-6 w-4 h-4 bg-white border-b-4 border-r-4 border-sky-400 transform rotate-45"></div></div>}
                                <GameButton onClick={handleSkipQuestion} color="purple" className="py-4" title="換一題"><Shuffle className="w-6 h-6" /></GameButton>
                                <GameButton onClick={handleMagicHint} color="yellow" className="py-4" title="提示下一個字"><Wand2 className="w-6 h-6" /></GameButton>
                                <GameButton onClick={handleGiveUpClick} color="red" className="py-4" title="查看答案"><Flag className="w-6 h-6" /></GameButton>
                        </div>
                        <GameButton onClick={checkAnswer} disabled={userSentence.length === 0} color="blue" className="flex-1 py-4 text-xl shadow-lg"><CheckCircle className="w-6 h-6" /> 檢查</GameButton>
                        </>
                    )}
                </div>
                <div className="flex flex-wrap gap-2 justify-center z-10 relative pb-4">
                    {availableWords.map((wordObj) => (<button key={wordObj.id} onClick={() => handleWordClick(wordObj)} className="bg-white text-slate-700 px-5 py-3 rounded-xl font-bold shadow-[0_4px_0_rgb(203,213,225)] active:shadow-none active:translate-y-1 transition-all border-2 border-slate-200 text-lg hover:border-indigo-300 hover:text-indigo-600">{wordObj.text}</button>))}
                </div>
                {showGiveUpConfirm && (
                    <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm rounded-3xl animate-in fade-in">
                        <div className="bg-white p-6 rounded-3xl border-4 border-slate-200 shadow-2xl max-w-xs text-center transform scale-100 animate-in zoom-in">
                            <div className="flex justify-center mb-4"><AlertCircle className="w-16 h-16 text-yellow-400" /></div>
                            <h3 className="text-2xl font-black text-slate-800 mb-2">Wait!</h3>
                            <p className="text-slate-500 font-bold mb-6">真的不自己再試試看嗎？<br/>自己拼出來會很有成就感喔！</p>
                            <div className="flex gap-3 justify-center">
                                <GameButton onClick={() => setShowGiveUpConfirm(false)} color="blue" className="text-sm">再試一次</GameButton>
                                <GameButton onClick={confirmGiveUp} color="gray" className="text-sm">我看答案</GameButton>
                            </div>
                        </div>
                    </div>
                )}
            </div>
            );
        };

        // --- 元件 2: 測驗模式 (整合 & 選擇題大亂鬥 & 拼字分類) ---
        const QuizMode = ({ data, grammarData }) => {
            const [quizType, setQuizType] = useState('choice'); 
            const [status, setStatus] = useState('menu'); 
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [quizData, setQuizData] = useState([]);
            const [selectedOption, setSelectedOption] = useState(null);
            const [spellingData, setSpellingData] = useState([]); // 新增：用於儲存過濾後的拼字資料
            const [timeLeft, setTimeLeft] = useState(7); // 新增：倒數時間狀態
            const [history, setHistory] = useState([]); // 新增：答題歷史紀錄

            const startChoiceQuiz = () => {
                if (!data || data.length === 0) return;
                // 修改：增加題數至 50 題 (使用雙向出題增加題庫量)
                const allVocabQuestions = [];
                data.forEach(target => {
                    // Q1: 英 -> 中
                    const distractors1 = shuffleArray(data.filter(w => w.id !== target.id)).slice(0, 3);
                    allVocabQuestions.push({
                        questionText: target.word,
                        correctId: target.id,
                        correctAnswer: target.chinese, // 紀錄正確答案文字
                        options: shuffleArray([target, ...distractors1]).map(o => ({
                            id: o.id,
                            text: o.chinese,
                            isCorrect: o.id === target.id
                        })),
                        hint: "請選出中文意思",
                        audio: target.word
                    });
                    
                    // Q2: 中 -> 英
                    const distractors2 = shuffleArray(data.filter(w => w.id !== target.id)).slice(0, 3);
                    allVocabQuestions.push({
                        questionText: target.chinese,
                        correctId: target.id,
                        correctAnswer: target.word, // 紀錄正確答案文字
                        options: shuffleArray([target, ...distractors2]).map(o => ({
                            id: o.id,
                            text: o.word,
                            isCorrect: o.id === target.id
                        })),
                        hint: "請選出英文單字",
                        audio: null
                    });
                });

                // 隨機選取 10 題
                const selectedQuestions = shuffleArray(allVocabQuestions).slice(0, 10);
                
                setQuizData(selectedQuestions);
                setCurrentQIndex(0);
                setScore(0);
                setHistory([]);
                setSelectedOption(null);
                setQuizType('choice');
                setStatus('playing');
                setTimeLeft(7); // 重置時間
            };

            const startSpellingQuiz = (type) => {
                let filteredData = [];
                if (!data) return;
                if (type === 'words') {
                    // 過濾掉片語 (part !== 'phr.')
                    filteredData = data.filter(item => item.part !== 'phr.');
                } else if (type === 'phrases') {
                    // 只留片語 (part === 'phr.')
                    filteredData = data.filter(item => item.part === 'phr.');
                }

                if (filteredData.length === 0) {
                    alert("這個單元沒有這類型的題目喔！");
                    return;
                }

                setSpellingData(filteredData);
                setQuizType('spelling');
                setStatus('playing');
            };

            const handleOptionClick = (option) => {
                if (selectedOption) return; 
                
                // 計算分數 (剩餘時間比例 * 100，無條件進位)
                let points = 0;
                if (option.isCorrect) {
                    points = Math.ceil((timeLeft / 7.0) * 100);
                    // 確保至少有一點分數 (如果正確且時間未到)
                    if (points <= 0 && timeLeft > 0) points = 10; 
                }

                const currentQ = quizData[currentQIndex];
                
                // 記錄歷史
                setHistory(prev => [...prev, {
                    q: currentQ.questionText,
                    correct: currentQ.correctAnswer,
                    user: option.text,
                    isCorrect: option.isCorrect,
                    points: points
                }]);

                setSelectedOption(option);
                if (currentQ.audio) speakText(currentQ.audio);
                
                if (option.isCorrect) {
                    setScore(prev => prev + points);
                }
            };

            const nextQuestion = () => {
                if (currentQIndex < quizData.length - 1) {
                    setCurrentQIndex(prev => prev + 1);
                    setSelectedOption(null);
                    setTimeLeft(7); // 重置時間
                } else {
                    setStatus('result');
                }
            };

            // 倒數計時器 Effect
            useEffect(() => {
                if (status !== 'playing' || quizType !== 'choice' || selectedOption) return;

                if (timeLeft <= 0) {
                    // 時間到處理邏輯
                    const currentQ = quizData[currentQIndex];
                    setHistory(prev => [...prev, {
                        q: currentQ.questionText,
                        correct: currentQ.correctAnswer,
                        user: "(逾時)",
                        isCorrect: false,
                        points: 0
                    }]);

                    setSelectedOption({ id: 'timeout' }); // 標記為超時
                    speakText("Time's up");
                    return;
                }

                const timer = setInterval(() => {
                    setTimeLeft(prev => prev - 1);
                }, 1000);

                return () => clearInterval(timer);
            }, [timeLeft, status, quizType, selectedOption]);

            // 計算是否有片語，決定是否顯示「片語篇」按鈕
            const hasPhrases = data ? data.some(item => item.part === 'phr.') : false;
            const hasWords = data ? data.some(item => item.part !== 'phr.') : false;

            if (status === 'menu') {
                return (
                    <div className="flex flex-col items-center justify-center h-full animate-in fade-in space-y-4 pt-4 overflow-y-auto">
                        <div className="text-center mb-2"><Gamepad2 className="w-16 h-16 mx-auto text-sky-400 mb-2" /><h2 className="text-2xl font-black text-slate-700">選擇測驗模式</h2></div>
                        
                        {/* 選擇題 (大亂鬥) */}
                        <button onClick={startChoiceQuiz} className="w-full max-w-xs bg-white border-4 border-slate-200 p-5 rounded-3xl hover:border-sky-400 group transition-all shadow-sm hover:shadow-md text-left relative overflow-hidden">
                            <div className="absolute right-[-20px] top-[-20px] bg-sky-100 w-24 h-24 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                            <div className="relative z-10 flex items-center gap-4"><div className="bg-sky-500 text-white p-3 rounded-2xl"><MousePointerClick className="w-6 h-6" /></div><div><h3 className="text-lg font-black text-slate-800">選擇題大挑戰</h3><p className="text-xs text-slate-500 font-bold">10題 限時搶答 (每題7秒)</p></div></div>
                        </button>

                        <div className="w-full max-w-xs space-y-3">
                            <div className="text-slate-400 text-xs font-black uppercase tracking-wider pl-2">Spelling Mode</div>
                            
                            {/* 拼字：單字篇 */}
                            {hasWords && (
                                <button onClick={() => startSpellingQuiz('words')} className="w-full bg-white border-4 border-slate-200 p-4 rounded-3xl hover:border-violet-400 group transition-all shadow-sm hover:shadow-md text-left relative overflow-hidden">
                                    <div className="absolute right-[-20px] top-[-20px] bg-violet-100 w-20 h-20 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                                    <div className="relative z-10 flex items-center gap-3"><div className="bg-violet-500 text-white p-2.5 rounded-2xl"><Keyboard className="w-5 h-5" /></div><div><h3 className="text-lg font-black text-slate-800">拼字：單字篇</h3><p className="text-xs text-slate-500 font-bold">Vocabulary Only</p></div></div>
                                </button>
                            )}

                            {/* 拼字：片語篇 */}
                            {hasPhrases && (
                                <button onClick={() => startSpellingQuiz('phrases')} className="w-full bg-white border-4 border-slate-200 p-4 rounded-3xl hover:border-pink-400 group transition-all shadow-sm hover:shadow-md text-left relative overflow-hidden">
                                    <div className="absolute right-[-20px] top-[-20px] bg-pink-100 w-20 h-20 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                                    <div className="relative z-10 flex items-center gap-3"><div className="bg-pink-500 text-white p-2.5 rounded-2xl"><Filter className="w-5 h-5" /></div><div><h3 className="text-lg font-black text-slate-800">拼字：片語篇</h3><p className="text-xs text-slate-500 font-bold">Phrases & Idioms</p></div></div>
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            if (status === 'result') {
                // 評語邏輯
                let feedbackTitle = "";
                let feedbackColor = "";
                if (score >= 900) {
                    feedbackTitle = "厲害！";
                    feedbackColor = "text-yellow-500";
                } else if (score >= 800) {
                    feedbackTitle = "不錯！";
                    feedbackColor = "text-emerald-500";
                } else if (score >= 700) {
                    feedbackTitle = "還可以";
                    feedbackColor = "text-sky-500";
                } else {
                    feedbackTitle = "加油加油再測一次";
                    feedbackColor = "text-slate-500";
                }

                return (
                    <div className="flex flex-col h-full animate-in zoom-in pt-4 pb-20 overflow-y-auto">
                        <div className="flex flex-col items-center justify-center mb-6">
                            <Trophy className={`w-24 h-24 drop-shadow-xl animate-bounce mb-2 ${score >= 800 ? 'text-yellow-400' : 'text-slate-300'}`} />
                            <h2 className={`text-3xl font-black mb-1 ${feedbackColor}`}>{feedbackTitle}</h2>
                            <div className="text-6xl font-black text-slate-800 mb-2">{score} <span className="text-xl text-slate-400">分</span></div>
                        </div>

                        {/* 成績總表 */}
                        <div className="bg-white rounded-2xl shadow-sm border-2 border-slate-200 overflow-hidden mx-1 mb-6">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-slate-500 uppercase bg-slate-100 border-b border-slate-200">
                                    <tr>
                                        <th className="px-3 py-3 w-10">#</th>
                                        <th className="px-3 py-3">題目</th>
                                        <th className="px-3 py-3 text-center">得分</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {history.map((record, idx) => (
                                        <tr key={idx} className="border-b border-slate-100 last:border-0 hover:bg-slate-50">
                                            <td className="px-3 py-3 font-bold text-slate-400">{idx + 1}</td>
                                            <td className="px-3 py-3">
                                                <div className="font-bold text-slate-700">{record.q}</div>
                                                <div className="flex flex-col text-xs mt-1 gap-0.5">
                                                    <div className={record.isCorrect ? "text-emerald-600" : "text-rose-500 font-bold"}>
                                                        {record.isCorrect ? "●" : "✕"} 您選: {record.user}
                                                    </div>
                                                    {!record.isCorrect && (
                                                        <div className="text-emerald-600 font-bold">
                                                            ✓ 正解: {record.correct}
                                                        </div>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="px-3 py-3 text-center font-black text-slate-700">
                                                {record.points > 0 ? <span className="text-emerald-500">+{record.points}</span> : <span className="text-slate-300">0</span>}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="flex justify-center pb-8">
                            <GameButton onClick={() => setStatus('menu')} color="green" className="w-64 text-xl py-4">回到選單</GameButton>
                        </div>
                    </div>
                );
            }

            // 拼字模式使用過濾後的資料
            if (quizType === 'spelling') return <SpellingQuiz data={spellingData} onFinish={(s) => { setScore(s); setStatus('result'); }} />;

            // 選擇題模式 (新版通用渲染器)
            const currentQ = quizData[currentQIndex];

            return (
                <div className="flex flex-col h-full max-w-md mx-auto">
                    <div className="mb-4 px-1 flex items-center justify-between"><div className="bg-white border-2 border-slate-200 px-3 py-1 rounded-full font-black text-slate-400 text-xs shadow-sm">STAGE {currentQIndex + 1} / {quizData.length}</div><div className="bg-yellow-100 border-2 border-yellow-300 px-3 py-1 rounded-full font-black text-yellow-700 text-xs shadow-sm">SCORE: {score}</div></div>
                    
                    {/* 時間倒數條 */}
                    <div className="relative h-6 bg-slate-100 rounded-full overflow-hidden border-2 border-slate-300 mb-4 mx-1">
                        <div 
                            className={`h-full transition-all duration-1000 ease-linear ${timeLeft <= 3 ? 'bg-rose-500' : 'bg-sky-400'}`} 
                            style={{ width: `${(timeLeft / 7) * 100}%` }}
                        ></div>
                        <div className="absolute inset-0 flex items-center justify-center text-xs font-black text-slate-600 drop-shadow-sm">
                            <Timer className="w-3 h-3 mr-1" /> {timeLeft}s (滿分遞減)
                        </div>
                    </div>

                    <div className="bg-white border-4 border-b-8 border-violet-200 rounded-3xl p-8 mb-6 text-center relative overflow-hidden shadow-sm group">
                        <div className="absolute top-3 left-1/2 -translate-x-1/2 bg-violet-100 text-violet-600 px-3 py-1 rounded-lg text-xs font-black uppercase tracking-wider">Question</div>
                        <h2 className="font-black text-3xl text-slate-800 mt-6 leading-relaxed">{currentQ.questionText}</h2>
                        {currentQ.audio && <button onClick={() => speakText(currentQ.audio)} className="mt-4 p-2 bg-slate-100 rounded-full text-slate-400 hover:text-violet-500 hover:bg-violet-50 border-2 border-slate-200 hover:border-violet-200 transition-colors"><Volume2 className="w-6 h-6 mx-auto" /></button>}
                    </div>
                    <div className="grid grid-cols-1 gap-3 pb-8">
                        {currentQ.options.map((option, idx) => {
                            let color = "white";
                            // 如果已選擇(包括時間到)
                            if (selectedOption) {
                                if (option.isCorrect) color = "green"; // 正確答案總是顯示綠色
                                else if (selectedOption.id === option.id && !option.isCorrect) color = "red"; // 如果選錯了顯示紅色
                                else if (selectedOption.id === 'timeout' && !option.isCorrect) color = "white"; // 時間到沒選的顯示白色
                            }
                            
                            return (
                                <GameButton key={idx} disabled={!!selectedOption} onClick={() => handleOptionClick(option)} color={color} className={`justify-between py-4 text-left ${!selectedOption && "hover:bg-slate-50"}`}>
                                    <span className="text-lg">{option.text}</span>
                                    {selectedOption && option.isCorrect && <CheckCircle className="w-6 h-6 animate-bounce" />}
                                    {selectedOption && selectedOption.id === option.id && !option.isCorrect && <XCircle className="w-6 h-6 animate-pulse" />}
                                </GameButton>
                            );
                        })}
                    </div>
                    {selectedOption && <div className="fixed bottom-6 left-0 right-0 p-4 bg-transparent pointer-events-none flex justify-center z-20"><button onClick={nextQuestion} className="pointer-events-auto bg-slate-800 text-white px-8 py-4 rounded-2xl font-black text-xl shadow-2xl hover:bg-slate-900 hover:scale-105 transition-all flex items-center gap-2 animate-in slide-in-from-bottom-4 border-b-8 border-black">{currentQIndex < quizData.length - 1 ? "NEXT STAGE" : "FINISH"} <ChevronRight className="w-6 h-6" /></button></div>}
                </div>
            );
        };

        // --- 元件 4: 文法模式 (修正：10題隨機，音效，結算頁面，即時完整解釋，題目顏色反饋) ---
        const GrammarMode = ({ grammarData }) => {
            const [mode, setMode] = useState('notes'); // 'notes', 'quiz', 'scramble'
            const [currentQuizIndex, setCurrentQuizIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [status, setStatus] = useState('menu'); // 'menu', 'playing', 'result'
            const [selectedOption, setSelectedOption] = useState(null);
            const [quizList, setQuizList] = useState([]);
            const [history, setHistory] = useState([]); // 紀錄答題歷史

            // 輔助函式：處理題庫資料，確保選項被打亂
            const prepareQuizData = (rawList) => {
                if (!rawList) return [];
                // 隨機選取 10 題
                const selected = shuffleArray([...rawList]).slice(0, 10);
                return selected.map(item => ({
                    ...item,
                    options: shuffleArray([...item.options]) // 強制打亂選項
                }));
            };

            useEffect(() => {
                // 初始化
                setMode('notes');
                setStatus('menu');
            }, [grammarData]);

            const startQuiz = () => {
                if (grammarData?.quiz) { 
                    setQuizList(prepareQuizData(grammarData.quiz));
                    setCurrentQuizIndex(0);
                    setScore(0);
                    setHistory([]);
                    setSelectedOption(null);
                    setStatus('playing');
                }
            };

            const handleOptionClick = (option, correctAns, qItem) => {
                if (selectedOption) return;
                setSelectedOption(option);
                
                const isCorrect = option === correctAns;
                if (isCorrect) { 
                    setScore(prev => prev + 10); 
                    playSound('correct');
                } else { 
                    playSound('wrong'); 
                }

                // 記錄歷史
                setHistory(prev => [...prev, {
                    question: qItem.q,
                    userAns: option,
                    correctAns: correctAns,
                    isCorrect: isCorrect,
                    hint: qItem.hint
                }]);
            };

            const nextQuestion = () => {
                if (currentQuizIndex < quizList.length - 1) { 
                    setCurrentQuizIndex(prev => prev + 1); 
                    setSelectedOption(null); 
                } else { 
                    setStatus('result'); 
                }
            };

            const restartQuiz = () => {
                startQuiz();
            };

            if (!grammarData || !grammarData.notes) return <div>Grammar content coming soon!</div>;

            return (
                <div className="flex flex-col h-full animate-in fade-in">
                    <div className="flex justify-center mb-6 gap-2">
                        <GameButton onClick={() => setMode('notes')} active={mode === 'notes'} color="white" className="text-sm px-3"><PenTool className="w-4 h-4" /> 筆記</GameButton>
                        <GameButton onClick={() => { setMode('quiz'); startQuiz(); }} active={mode === 'quiz'} color="white" className="text-sm px-3"><CheckCircle className="w-4 h-4" /> 挑戰</GameButton>
                        <GameButton onClick={() => setMode('scramble')} active={mode === 'scramble'} color="white" className="text-sm px-3"><Puzzle className="w-4 h-4" /> 句型重組</GameButton>
                    </div>

                    {mode === 'notes' && (
                        <div className="flex-1 overflow-y-auto pb-20 space-y-4">
                            {/* 新增 Tip 區塊 */}
                            {grammarData.tips && (
                                <div className="bg-yellow-50 border-4 border-yellow-200 rounded-3xl p-5 mb-4 shadow-sm animate-in slide-in-from-top-2">
                                    <h3 className="text-xl font-black text-yellow-700 mb-3 flex items-center gap-2">
                                        <Lightbulb className="w-6 h-6 fill-yellow-400 text-yellow-600" /> 
                                        作答小技巧 (Exam Tips)
                                    </h3>
                                    <div className="grid grid-cols-1 gap-2">
                                        {grammarData.tips.map((tip, i) => (
                                            <div key={i} className="bg-white p-3 rounded-xl border-l-4 border-yellow-400 shadow-sm flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3">
                                                <span className="font-black text-slate-700 bg-yellow-100 px-2 py-0.5 rounded text-sm whitespace-nowrap">{tip.label}</span>
                                                <span className="text-slate-600 text-sm font-bold">{tip.text}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {grammarData.notes.map((note, idx) => (
                                <div key={idx} className="bg-white border-4 border-slate-200 rounded-3xl p-6 shadow-sm hover:border-indigo-300 transition-colors">
                                    <h3 className="text-xl font-black text-indigo-600 mb-2 flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500 text-sm">{idx+1}</div>{note.title}</h3>
                                    <div className="bg-slate-100 p-3 rounded-xl font-bold text-slate-700 mb-3 border-l-4 border-slate-400">{note.rule}</div>
                                    <p className="text-slate-500 text-sm mb-4 font-bold">{note.desc}</p>
                                    <div className="space-y-2">{note.examples.map((ex, i) => (<div key={i} className="flex gap-2 text-slate-600 text-sm font-medium"><span className="text-green-500 font-bold">✓</span> {ex}</div>))}</div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {mode === 'scramble' && <ScrambleMode data={grammarData.scramble || []} titleOverride="GRAMMAR SCRAMBLE" />}
                    
                    {mode === 'quiz' && (
                        status === 'result' ? (
                            <div className="flex flex-col h-full animate-in zoom-in pb-20 overflow-y-auto">
                                <div className="flex flex-col items-center justify-center mb-6 pt-4">
                                    <Trophy className="w-20 h-20 text-yellow-400 drop-shadow-lg mb-2" />
                                    <h2 className="text-3xl font-black text-slate-800 mb-1">測驗完成！</h2>
                                    <div className="text-5xl font-black text-indigo-600 mb-4">{score} <span className="text-xl text-slate-400">分</span></div>
                                    <GameButton onClick={restartQuiz} color="green" className="w-48 text-lg">再測驗一次</GameButton>
                                </div>
                                
                                <div className="space-y-4 px-2">
                                    {history.map((item, idx) => (
                                        <div key={idx} className={`bg-white border-l-8 rounded-xl p-4 shadow-sm ${item.isCorrect ? 'border-emerald-400' : 'border-rose-400'}`}>
                                            <div className="flex items-start gap-3 mb-2">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold shrink-0 ${item.isCorrect ? 'bg-emerald-500' : 'bg-rose-500'}`}>
                                                    {item.isCorrect ? <CheckCircle size={18} /> : <XCircle size={18} />}
                                                </div>
                                                <div className="flex-1">
                                                    {/* 結果列表題目中也填入正確答案 */}
                                                    <h4 className="font-bold text-slate-800 text-lg">
                                                        {item.question.split('______').map((part, i, arr) => (
                                                            <React.Fragment key={i}>
                                                                {part}
                                                                {i < arr.length - 1 && <span className="text-emerald-600 border-b-2 border-emerald-400 px-1">{item.correctAns}</span>}
                                                            </React.Fragment>
                                                        ))}
                                                    </h4>
                                                    <div className="flex flex-wrap gap-2 mt-2 text-sm">
                                                        <span className={`px-2 py-1 rounded font-bold ${item.isCorrect ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>
                                                            你的答案: {item.userAns}
                                                        </span>
                                                        {!item.isCorrect && (
                                                            <span className="px-2 py-1 rounded font-bold bg-emerald-100 text-emerald-700">
                                                                正解: {item.correctAns}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* 顯眼的解釋卡片 */}
                                            <div className="mt-3 bg-indigo-50 border-2 border-indigo-100 rounded-lg p-3 flex items-start gap-2">
                                                <Info className="w-5 h-5 text-indigo-500 shrink-0 mt-0.5" />
                                                <p className="text-indigo-700 text-sm font-bold">{item.hint}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="flex flex-col h-full max-w-md mx-auto relative pt-4">
                                {quizList.length > 0 && (
                                    <>
                                        <div className="mb-4 flex justify-between items-center px-1">
                                            <span className="text-xs font-black text-slate-400 uppercase tracking-wider">Question {currentQuizIndex + 1} / {quizList.length}</span>
                                            <span className="text-xs font-black text-yellow-600 bg-yellow-100 px-2 py-1 rounded-lg">SCORE: {score}</span>
                                        </div>
                                        <div className="bg-white border-4 border-b-8 border-indigo-200 rounded-3xl p-6 mb-6 min-h-[140px] flex items-center justify-center text-center shadow-sm relative">
                                            <h3 className="text-xl font-black text-slate-700 leading-relaxed">
                                                {quizList[currentQuizIndex].q.split('______').map((part, i, arr) => (
                                                    <React.Fragment key={i}>
                                                        {part}
                                                        {i < arr.length - 1 && (
                                                            selectedOption ? (
                                                                // 已作答狀態：直接填入正確答案，用顏色區分對錯
                                                                <span className={`inline-block min-w-[60px] border-b-4 mx-1 font-black ${selectedOption === quizList[currentQuizIndex].ans ? 'text-emerald-500 border-emerald-400' : 'text-rose-500 border-rose-400'}`}>
                                                                    {quizList[currentQuizIndex].ans}
                                                                </span>
                                                            ) : (
                                                                // 未作答狀態：顯示問號
                                                                <span className="inline-block min-w-[60px] border-b-4 mx-1 font-bold text-indigo-600 border-indigo-400">?</span>
                                                            )
                                                        )}
                                                    </React.Fragment>
                                                ))}
                                            </h3>
                                        </div>
                                        <div className="grid grid-cols-1 gap-3">
                                            {quizList[currentQuizIndex].options.map((opt, idx) => {
                                                const isCorrect = opt === quizList[currentQuizIndex].ans;
                                                let btnColor = "white";
                                                if (selectedOption) {
                                                    if (isCorrect) btnColor = "green";
                                                    else if (selectedOption === opt) btnColor = "red";
                                                }
                                                return (
                                                    <GameButton key={idx} onClick={() => handleOptionClick(opt, quizList[currentQuizIndex].ans, quizList[currentQuizIndex])} disabled={!!selectedOption} color={btnColor} className="py-3 text-lg justify-between">
                                                        {opt}
                                                        {selectedOption && isCorrect && <CheckCircle className="w-5 h-5" />}
                                                        {selectedOption === opt && !isCorrect && <XCircle className="w-5 h-5" />}
                                                    </GameButton>
                                                )
                                            })}
                                        </div>
                                        
                                        {/* 即時完整解釋區塊 (不論對錯都顯示) */}
                                        {selectedOption && (
                                            <div className="mt-4 animate-in fade-in slide-in-from-bottom-2">
                                                <div className={`p-4 rounded-xl border-l-4 mb-4 shadow-sm ${selectedOption === quizList[currentQuizIndex].ans ? 'bg-emerald-50 border-emerald-500 text-emerald-900' : 'bg-rose-50 border-rose-500 text-rose-900'}`}>
                                                    <div className="flex items-center gap-2 mb-2 font-black text-lg">
                                                        {selectedOption === quizList[currentQuizIndex].ans ? 
                                                            <><CheckCircle className="w-6 h-6" /> 答對了！</> : 
                                                            <><XCircle className="w-6 h-6" /> 答錯了！</>
                                                        }
                                                    </div>
                                                    {!selectedOption === quizList[currentQuizIndex].ans && (
                                                        <div className="mb-2 text-sm font-bold">正確答案是：<span className="text-lg mx-1 underline">{quizList[currentQuizIndex].ans}</span></div>
                                                    )}
                                                    {/* 完整解釋 (移除紫色圓圈，改為純文字標籤) */}
                                                    <div className="bg-white/80 p-3 rounded-lg border border-black/10 shadow-inner">
                                                        <p className="text-sm text-slate-500 font-bold mb-1">解釋：</p>
                                                        <p className="text-base font-bold text-slate-800">{quizList[currentQuizIndex].hint}</p>
                                                    </div>
                                                </div>
                                                <div className="flex justify-center">
                                                    <GameButton onClick={nextQuestion} color="blue" className="w-full text-lg py-3 shadow-lg border-b-4 border-blue-600 active:border-b-0">
                                                        {currentQuizIndex < quizList.length - 1 ? "下一題" : "看成績"} <ChevronRight className="w-5 h-5" />
                                                    </GameButton>
                                                </div>
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        )
                    )}
                </div>
            );
        };

        // --- Main App Container ---
        function Unit34App() {
            const [activeTab, setActiveTab] = useState('study');
            const [currentUnit, setCurrentUnit] = useState('unitCardinals'); 

            const unitTitle = UNITS_DATA[currentUnit].title;
            const unitData = UNITS_DATA[currentUnit].vocab;
            const unitGrammar = UNITS_DATA[currentUnit].grammar;

            useEffect(() => { document.body.classList.add('loaded'); }, []);

            return (
                <div className="min-h-screen font-sans text-slate-800 flex flex-col bg-sky-50 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px]">
                <div className="bg-white/90 backdrop-blur-sm sticky top-0 z-50 border-b-4 border-slate-200">
                    <div className="max-w-md mx-auto px-4 py-3">
                    <div className="flex justify-between items-center mb-3 bg-slate-100 p-2 rounded-2xl border-2 border-slate-200 overflow-x-auto">
                        <div className="flex items-center gap-2 font-black text-slate-600 text-lg tracking-tight ml-2 mr-2 whitespace-nowrap"><Map className="w-6 h-6 text-sky-500" /><span>MAP</span></div>
                        <div className="flex gap-2">
                            {['unitCardinals', 'unitOrdinals', 'unit5', 'unit6'].map(uKey => (
                            <button key={uKey} onClick={() => setCurrentUnit(uKey)} className={`px-3 py-1 text-xs sm:text-sm font-black rounded-xl transition-all border-b-4 active:border-b-0 active:translate-y-1 whitespace-nowrap ${currentUnit === uKey ? 'bg-sky-500 border-sky-700 text-white shadow-sky-200' : 'bg-white border-slate-300 text-slate-400 hover:bg-slate-50'}`}>{UNITS_DATA[uKey].title}</button>
                            ))}
                        </div>
                    </div>
                    <div className="grid grid-cols-4 gap-2">
                        <GameButton onClick={() => setActiveTab('study')} active={activeTab === 'study'} color={activeTab === 'study' ? 'active' : 'white'} className="text-xs py-3 px-1"><Layers className="w-3 h-3 md:w-4 md:h-4" /> 學習</GameButton>
                        <GameButton onClick={() => setActiveTab('quiz')} active={activeTab === 'quiz'} color={activeTab === 'quiz' ? 'active' : 'white'} className="text-xs py-3 px-1"><CheckCircle className="w-3 h-3 md:w-4 md:h-4" /> 測驗</GameButton>
                        <GameButton onClick={() => setActiveTab('sentences')} active={activeTab === 'sentences'} color={activeTab === 'sentences' ? 'active' : 'white'} className="text-xs py-3 px-1"><Puzzle className="w-3 h-3 md:w-4 md:h-4" /> 重組</GameButton>
                        <GameButton onClick={() => setActiveTab('grammar')} active={activeTab === 'grammar'} color={activeTab === 'grammar' ? 'active' : 'white'} className="text-xs py-3 px-1"><GraduationCap className="w-3 h-3 md:w-4 md:h-4" /> 文法</GameButton>
                    </div>
                    </div>
                </div>
                <div className="flex-1 max-w-md mx-auto w-full p-4 pt-6">
                    <div className="mb-6 text-center"><span className="inline-flex items-center gap-2 bg-slate-800 text-white text-xs font-black px-4 py-1.5 rounded-full border-2 border-slate-600 shadow-md"><Map className="w-3 h-3 text-yellow-400" />目前關卡：{unitTitle}</span></div>
                    {activeTab === 'study' && <StudyMode data={unitData} />}
                    {activeTab === 'quiz' && <QuizMode data={unitData} grammarData={unitGrammar} />}
                    {activeTab === 'sentences' && <ScrambleMode data={unitData} />}
                    {activeTab === 'grammar' && <GrammarMode grammarData={unitGrammar} />}
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Unit34App />);
    </script>
</body>
</html>
