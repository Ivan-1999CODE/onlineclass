<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¯é€±å–®å­—ç‰¹è¨“ç­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6;
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 20px 20px;
            /* Prevent pull-to-refresh on mobile */
            overscroll-behavior: none;
        }
        
        /* Card Flip Animation */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-inner { transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Custom Scrollbar - Minimalist */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* Hide Scrollbar but allow scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Sidebar Transition */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }

        /* Sentence Builder Styles */
        .word-chip {
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .word-chip:active { transform: scale(0.95); }
        
        /* General Touch Optimization */
        button { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="min-h-[100dvh] flex items-center justify-center p-2 md:p-6 overflow-hidden">

    <!-- Main App Container -->
    <div class="w-full max-w-md md:max-w-lg lg:max-w-xl bg-white rounded-[2rem] shadow-2xl overflow-hidden border-4 border-white ring-1 ring-gray-100 flex flex-col h-[92dvh] md:h-[85vh] relative transform transition-all duration-300">
        
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="absolute inset-0 bg-black/40 backdrop-blur-[2px] z-40 hidden opacity-0 touch-none"></div>

        <!-- Sidebar -->
        <div id="sidebar" class="absolute top-0 left-0 w-72 h-full bg-white z-50 transform -translate-x-full shadow-2xl flex flex-col">
            <div class="p-6 bg-gradient-to-br from-violet-600 to-indigo-600 text-white shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="library" class="w-6 h-6"></i> èª²ç¨‹é¸å–®
                    </h2>
                    <button onclick="toggleSidebar()" class="p-1 hover:bg-white/20 rounded-full transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <p class="text-violet-100 text-sm">é¸æ“‡æ‚¨çš„å­¸ç¿’é€²åº¦</p>
            </div>
            <div class="flex-1 overflow-y-auto p-3 space-y-2">
                <button onclick="loadWeek(1)" class="w-full text-left p-4 rounded-xl hover:bg-violet-50 text-gray-700 font-medium transition-all flex justify-between items-center group active:scale-[0.98]" id="week-btn-1">
                    <span class="flex items-center gap-3"><span class="text-2xl">ğŸ“…</span> ç¬¬ä¸€é€±ï¼šåŸºç¤ç¯‡</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 group-hover:text-violet-500"></i>
                </button>
                <button onclick="loadWeek(2)" class="w-full text-left p-4 rounded-xl hover:bg-violet-50 text-gray-700 font-medium transition-all flex justify-between items-center group active:scale-[0.98]" id="week-btn-2">
                    <span class="flex items-center gap-3"><span class="text-2xl">â„ï¸</span> ç¬¬äºŒé€±ï¼šå†¬æ—¥èˆ‡æ­·å²</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 group-hover:text-violet-500"></i>
                </button>
                <button onclick="loadWeek(3)" class="w-full text-left p-4 rounded-xl hover:bg-gray-50 text-gray-400 font-medium transition-all flex justify-between items-center group cursor-not-allowed opacity-70" id="week-btn-3">
                    <span class="flex items-center gap-3"><span class="text-2xl">ğŸ”’</span> ç¬¬ä¸‰é€±ï¼šé€²éšé ç¿’</span>
                    <i data-lucide="lock" class="w-4 h-4 text-gray-300"></i>
                </button>
            </div>
            <div class="p-4 border-t border-gray-100 text-center text-xs text-gray-400 bg-gray-50">
                Vocabulary App v3.5 (More Quizzes)
            </div>
        </div>

        <!-- Header -->
        <div class="bg-gradient-to-r from-violet-500 to-fuchsia-500 pt-safe-top p-4 md:p-6 text-white text-center relative overflow-hidden shrink-0 z-10 shadow-md">
            <!-- Decorative Pattern -->
            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] pointer-events-none"></div>
            
            <div class="flex items-center justify-between relative z-10 mb-3">
                <button onclick="toggleSidebar()" class="p-2 -ml-2 rounded-xl hover:bg-white/20 active:bg-white/30 transition-colors">
                    <i data-lucide="menu" class="w-6 h-6 md:w-7 md:h-7 text-white"></i>
                </button>
                <h1 id="header-title" class="text-lg md:text-xl font-bold tracking-wide truncate px-2">Week 1</h1>
                <div class="w-10"></div> <!-- Spacer -->
            </div>
            
            <!-- Mode Switcher -->
            <div class="flex bg-black/10 p-1 rounded-2xl relative z-10 backdrop-blur-md gap-1 overflow-x-auto no-scrollbar snap-x">
                <button onclick="switchMode('study')" id="btn-study" class="snap-center flex-1 min-w-[70px] py-2.5 rounded-xl text-sm font-bold transition-all bg-white text-violet-600 shadow-sm whitespace-nowrap active:scale-95">
                    ğŸ“– è¤‡ç¿’
                </button>
                <button onclick="switchMode('sentence')" id="btn-sentence" class="snap-center flex-1 min-w-[70px] py-2.5 rounded-xl text-sm font-bold transition-all text-white hover:bg-white/10 whitespace-nowrap active:scale-95">
                    ğŸ§© å¥å‹
                </button>
                <button onclick="switchMode('quiz')" id="btn-quiz" class="snap-center flex-1 min-w-[70px] py-2.5 rounded-xl text-sm font-bold transition-all text-white hover:bg-white/10 whitespace-nowrap active:scale-95">
                    ğŸ¯ å–®å­—æ¸¬é©—
                </button>
                <button onclick="switchMode('grammar')" id="btn-grammar" class="snap-center flex-1 min-w-[70px] py-2.5 rounded-xl text-sm font-bold transition-all text-white hover:bg-white/10 whitespace-nowrap active:scale-95">
                    ğŸ“š æ–‡æ³•
                </button>
                <button onclick="switchMode('grammar-quiz')" id="btn-grammar-quiz" class="snap-center flex-1 min-w-[70px] py-2.5 rounded-xl text-sm font-bold transition-all text-white hover:bg-white/10 whitespace-nowrap active:scale-95">
                    ğŸ“ æ–‡æ³•æ¸¬é©—
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="p-4 md:p-8 flex-1 overflow-y-auto overflow-x-hidden relative bg-white scroll-smooth" id="content-area">
            
            <!-- VIEW: FLASHCARDS (STUDY) -->
            <div id="view-study" class="h-full flex flex-col relative max-w-md mx-auto w-full">
                
                <!-- View Toggle Switch -->
                <div class="flex justify-center mb-4 shrink-0">
                    <div class="bg-gray-100 p-1 rounded-xl flex shadow-inner">
                        <button onclick="setStudyView('card')" id="view-toggle-card" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-gray-800 shadow-sm flex items-center gap-1">
                            <i data-lucide="layers" class="w-3 h-3"></i> å¡ç‰‡
                        </button>
                        <button onclick="setStudyView('list')" id="view-toggle-list" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-400 hover:text-gray-600 flex items-center gap-1">
                            <i data-lucide="list" class="w-3 h-3"></i> åˆ—è¡¨
                        </button>
                    </div>
                </div>

                <!-- MODE A: CARD VIEW -->
                <div id="study-mode-card" class="flex-1 flex flex-col justify-between h-full overflow-hidden transition-opacity duration-300">
                    <div class="text-center mb-2 text-gray-400 text-xs font-bold tracking-widest uppercase">
                        Card <span id="fc-counter" class="text-violet-600">1</span> of <span id="fc-total">30</span>
                    </div>

                    <!-- Flashcard -->
                    <div class="perspective-1000 w-full flex-1 min-h-[250px] md:min-h-[350px] cursor-pointer group mb-6 select-none tap-highlight-transparent" onclick="flipCard()">
                        <div id="flashcard-inner" class="card-inner relative w-full h-full transform-style-3d shadow-[0_8px_30px_rgb(0,0,0,0.08)] rounded-3xl">
                            
                            <!-- Front (English) -->
                            <div class="absolute w-full h-full backface-hidden bg-white border border-gray-100 rounded-3xl flex flex-col items-center justify-center p-8 bg-gradient-to-br from-white via-white to-violet-50/50">
                                <span id="fc-part" class="absolute top-6 right-6 bg-violet-100 text-violet-700 text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wider">N.</span>
                                <h2 id="fc-en" class="text-4xl md:text-5xl font-bold text-gray-800 text-center mb-2 break-words leading-tight">Musician</h2>
                                <div class="mt-8 flex items-center gap-2 text-violet-400 text-sm animate-bounce">
                                    <i data-lucide="touchpad" class="w-4 h-4"></i>
                                    <span>é»æ“Šç¿»é¢</span>
                                </div>
                            </div>

                            <!-- Back (Chinese) -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-violet-600 text-white rounded-3xl flex flex-col items-center justify-center p-8 shadow-inner bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]">
                                <h2 id="fc-zh" class="text-4xl md:text-5xl font-bold text-center break-words leading-tight">éŸ³æ¨‚å®¶</h2>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex justify-between items-center gap-4 shrink-0 pb-2">
                        <button onclick="prevCard()" class="p-4 rounded-full bg-gray-50 hover:bg-gray-100 text-gray-600 transition-colors shadow-sm active:scale-90 border border-gray-100">
                            <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        </button>
                        
                        <button onclick="speakWord()" class="flex-1 py-4 bg-violet-50 text-violet-600 rounded-2xl font-bold hover:bg-violet-100 transition-colors flex items-center justify-center gap-2 active:scale-[0.98]">
                            <i data-lucide="volume-2" class="w-5 h-5"></i>
                            <span>ç™¼éŸ³</span>
                        </button>

                        <button onclick="nextCard()" class="p-4 rounded-full bg-violet-600 hover:bg-violet-700 text-white transition-colors shadow-lg shadow-violet-200 active:scale-90 ring-4 ring-violet-50">
                            <i data-lucide="chevron-right" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- MODE B: LIST VIEW -->
                <div id="study-mode-list" class="hidden flex-1 overflow-y-auto px-1 pb-4 transition-opacity duration-300">
                    <!-- List items will be injected here -->
                    <div id="vocab-list-container" class="space-y-3"></div>
                </div>

            </div>

            <!-- VIEW: SENTENCE BUILDER -->
            <div id="view-sentence" class="hidden h-full flex flex-col max-w-lg mx-auto w-full">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-sm font-bold text-gray-500 flex items-center gap-2">
                        <i data-lucide="puzzle" class="w-4 h-4"></i> é‡çµ„å¥å­
                    </span>
                    <span class="text-xs bg-violet-100 text-violet-700 px-3 py-1 rounded-full font-bold" id="sent-progress">1 / 5</span>
                </div>

                <!-- Chinese Hint -->
                <div class="bg-gradient-to-br from-gray-50 to-white p-6 rounded-2xl border border-gray-200 mb-6 text-center shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-violet-400"></div>
                    <p id="sent-zh" class="text-gray-800 font-bold text-xl md:text-2xl leading-relaxed">é€™ä½éŸ³æ¨‚å®¶æ­£åœ¨æ¼”å¥ã€‚</p>
                </div>

                <!-- Answer Area (Slots) -->
                <div id="sent-slots" class="flex flex-wrap gap-3 min-h-[100px] p-4 rounded-2xl bg-violet-50/30 border-2 border-dashed border-violet-200 items-start content-start mb-8 transition-colors duration-300">
                    <!-- Words move here -->
                </div>

                <!-- Word Bank -->
                <div class="flex-1">
                    <p class="text-xs text-gray-400 mb-3 text-center uppercase tracking-widest font-bold">Word Bank</p>
                    <div id="sent-bank" class="flex flex-wrap gap-3 justify-center content-start pb-4">
                        <!-- Words start here -->
                    </div>
                </div>

                <!-- Result/Next Button -->
                <div class="mt-auto pt-4 flex items-center justify-center h-20 shrink-0">
                    <div id="sent-feedback" class="hidden w-full">
                        <button onclick="nextSentence()" class="w-full py-4 bg-green-500 text-white rounded-2xl font-bold shadow-lg shadow-green-200 hover:bg-green-600 active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-lg animate-pulse">
                            <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                            <span>æ­£ç¢ºï¼ä¸‹ä¸€é¡Œ</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: QUIZ -->
            <div id="view-quiz" class="hidden h-full flex flex-col max-w-2xl mx-auto w-full">
                <div class="flex justify-between items-end mb-6 px-2">
                    <div class="flex flex-col">
                        <span class="text-xs text-gray-400 font-bold uppercase tracking-wider">Score</span>
                        <span id="score-display" class="text-3xl font-black text-violet-600 leading-none">0</span>
                    </div>
                    <div class="bg-orange-50 px-3 py-1 rounded-lg border border-orange-100">
                        <span class="text-sm text-orange-600 font-bold">Streak: <span id="streak-display">ğŸ”¥ 0</span></span>
                    </div>
                </div>

                <div class="bg-white border border-gray-100 rounded-3xl p-8 text-center shadow-[0_4px_20px_rgb(0,0,0,0.05)] mb-8 relative overflow-hidden shrink-0">
                    <div class="absolute top-0 inset-x-0 h-1 bg-gradient-to-r from-violet-400 via-fuchsia-400 to-violet-400"></div>
                    <span class="text-xs text-gray-400 uppercase tracking-widest font-bold">What is the meaning of?</span>
                    <h2 id="q-word" class="text-3xl md:text-4xl font-black text-gray-800 mt-3 mb-1">Word</h2>
                </div>

                <!-- Grid Layout: 1 col on mobile, 2 cols on tablet/desktop -->
                <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 overflow-y-auto pb-6 px-1">
                    <!-- Options injected here -->
                </div>

                <!-- Quiz Feedback Overlay -->
                <div id="feedback-overlay" class="absolute inset-0 bg-white/90 backdrop-blur-md z-20 hidden opacity-0 transition-opacity duration-300 flex flex-col items-center justify-center p-6 text-center">
                    <div id="feedback-icon" class="text-7xl mb-6 transform scale-0 transition-transform duration-300 drop-shadow-md">ğŸ‰</div>
                    <h3 id="feedback-text" class="text-3xl font-black text-gray-800 mb-6">Correct!</h3>
                    <button onclick="nextQuestion()" class="px-10 py-4 bg-violet-600 text-white rounded-full font-bold shadow-xl shadow-violet-200 hover:bg-violet-700 active:scale-95 transition-all text-lg flex items-center gap-2">
                        <span>ä¸‹ä¸€é¡Œ</span>
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- VIEW: GRAMMAR -->
            <div id="view-grammar" class="hidden h-full flex flex-col overflow-y-auto pb-4 max-w-2xl mx-auto w-full">
                <!-- Content injected via JS -->
            </div>

             <!-- VIEW: GRAMMAR QUIZ (NEW) -->
             <div id="view-grammar-quiz" class="hidden h-full flex flex-col max-w-2xl mx-auto w-full">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-sm font-bold text-gray-500 flex items-center gap-2">
                        <i data-lucide="pencil" class="w-4 h-4"></i> æ–‡æ³•æ¸¬é©—
                    </span>
                    <span class="text-xs bg-violet-100 text-violet-700 px-3 py-1 rounded-full font-bold" id="g-quiz-progress">1 / 8</span>
                </div>

                <!-- Question Card -->
                <div class="bg-white border border-gray-100 rounded-3xl p-6 md:p-8 shadow-[0_4px_20px_rgb(0,0,0,0.05)] mb-6 flex-1 flex flex-col justify-center text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-violet-400"></div>
                    <h2 id="g-quiz-q" class="text-2xl md:text-3xl font-bold text-gray-800 leading-relaxed mb-8">
                        I ___ a musician.
                    </h2>
                    
                    <!-- Options -->
                    <div id="g-quiz-options" class="grid grid-cols-1 gap-3 w-full max-w-md mx-auto">
                        <!-- Options injected via JS -->
                    </div>
                </div>

                <div id="g-quiz-feedback" class="h-16 flex items-center justify-center text-center">
                    <!-- Feedback msg -->
                </div>
            </div>

        </div>
    </div>

<script>
    // Initialize Lucide Icons
    lucide.createIcons();

    // --- Data Repository ---
    // Updated: Removed "to " from verbs
    const courseData = {
        1: {
            title: "English Vocab: Week 1",
            vocab: [
                { en: "music", zh: "éŸ³æ¨‚", part: "n." },
                { en: "lute", zh: "é­¯ç‰¹ç´", part: "n." },
                { en: "musician", zh: "éŸ³æ¨‚å®¶", part: "n." },
                { en: "country", zh: "åœ‹å®¶; åœ°å€", part: "n." },
                { en: "important", zh: "é‡è¦çš„", part: "adj." },
                { en: "cool", zh: "æ¶¼çˆ½çš„", part: "adj.", variants: "cooler, coolest" },
                { en: "holiday", zh: "å‡æœŸ", part: "n." },
                { en: "flight", zh: "èˆªç­; é£›è¡Œ", part: "n." },
                { en: "type", zh: "é¡å‹", part: "n." },
                { en: "prize", zh: "çé …; çè³", part: "n." },
                { en: "decide", zh: "æ±ºå®š", part: "v." },
                { en: "win", zh: "è´; ç²å‹", part: "v." },
                { en: "culture", zh: "æ–‡åŒ–", part: "n." },
                { en: "hot", zh: "ç†±çš„", part: "adj.", variants: "hotter, hottest" },
                { en: "planet", zh: "è¡Œæ˜Ÿ; åœ°çƒ", part: "n." },
                { en: "change", zh: "æ”¹è®Š; æ›´æ›", part: "v." },
                { en: "world", zh: "ä¸–ç•Œ", part: "n." },
                { en: "heat", zh: "ç†±åº¦; é«˜æº«", part: "n." },
                { en: "prefer", zh: "æ›´å–œæ­¡; åå¥½", part: "v." },
                { en: "love song", zh: "æƒ…æ­Œ", part: "n." },
                { en: "old", zh: "è€çš„", part: "adj.", variants: "older, oldest" },
                { en: "sad", zh: "å‚·å¿ƒçš„", part: "adj.", variants: "sadder, saddest" },
                { en: "perform", zh: "è¡¨æ¼”", part: "v." },
                { en: "barber", zh: "ç†é«®å¸«", part: "n." },
                { en: "competition", zh: "æ¯”è³½", part: "n." },
                { en: "design", zh: "è¨­è¨ˆ; åœ–æ¡ˆ", part: "n." },
                { en: "hair", zh: "é ­é«®; é«®å‹", part: "n." },
                { en: "realize", zh: "æ„è­˜åˆ°", part: "v." },
                { en: "animal", zh: "å‹•ç‰©", part: "n." },
                { en: "help", zh: "å¹«åŠ©", part: "v." },
                { en: "adopt", zh: "æ”¶é¤Š; é ˜é¤Š", part: "v." },
                { en: "problem", zh: "å•é¡Œ", part: "n." },
                { en: "dog", zh: "ç‹—", part: "n." }
            ],
            sentences: [
                { en: "The musician plays the lute", zh: "é€™ä½éŸ³æ¨‚å®¶æ¼”å¥é­¯ç‰¹ç´" },
                { en: "This is an important decision", zh: "é€™æ˜¯ä¸€å€‹é‡è¦çš„æ±ºå®š" },
                { en: "He wants to win the prize", zh: "ä»–æƒ³è¦è´å¾—é€™å€‹çé …" },
                { en: "The barber cuts hair", zh: "ç†é«®å¸«å‰ªé ­é«®" },
                { en: "I prefer pop music", zh: "æˆ‘æ¯”è¼ƒå–œæ­¡æµè¡ŒéŸ³æ¨‚" },
                { en: "It is the hottest day", zh: "é€™æ˜¯æœ€ç†±çš„ä¸€å¤©" },
                { en: "We live on a beautiful planet", zh: "æˆ‘å€‘ä½åœ¨ä¸€å€‹ç¾éº—çš„è¡Œæ˜Ÿä¸Š" },
                { en: "She won the competition", zh: "å¥¹è´å¾—äº†æ¯”è³½" },
                { en: "Do not be sad", zh: "ä¸è¦é›£é" },
                { en: "Culture is very important", zh: "æ–‡åŒ–éå¸¸é‡è¦" },
                { en: "They want to adopt a dog", zh: "ä»–å€‘æƒ³è¦é ˜é¤Šä¸€éš»ç‹—" }
            ],
            grammar: {
                title: "åŸºç¤å¥å‹è¤‡ç¿’",
                content: [
                    {
                        type: "rule",
                        title: "Be å‹•è© (am, is, are)",
                        desc: "ç”¨æ–¼æè¿°ç‹€æ…‹æˆ–èº«ä»½ã€‚",
                        examples: [
                            { en: "I am a musician.", zh: "æˆ‘æ˜¯ä¸€ä½éŸ³æ¨‚å®¶ã€‚" },
                            { en: "They are happy.", zh: "ä»–å€‘å¾ˆé–‹å¿ƒã€‚" }
                        ]
                    },
                    {
                        type: "rule",
                        title: "help çš„ç”¨æ³•",
                        desc: "1. help + (to) V (å¹«åŠ©åšæŸäº‹)<br>2. help + with + N (åœ¨æŸæ–¹é¢å¹«å¿™)",
                        examples: [
                            { en: "She helps clean the house.", zh: "å¥¹å¹«å¿™æ‰“æƒæˆ¿å­ã€‚" },
                            { en: "He helps with the homework.", zh: "ä»–å¹«å¿™åšåŠŸèª²ã€‚" }
                        ]
                    },
                    {
                        type: "rule",
                        title: "A be made of B",
                        desc: "è¡¨ç¤ºã€Œç”±...è£½æˆã€(ç‰©ç†è®ŠåŒ–ï¼Œä»å¯çœ‹å‡ºåŸææ–™)ã€‚",
                        examples: [
                            { en: "The table is made of wood.", zh: "é€™å¼µæ¡Œå­æ˜¯æœ¨é ­åšçš„ã€‚" },
                            { en: "The bottle is made of plastic.", zh: "é€™å€‹ç“¶å­æ˜¯å¡‘è† åšçš„ã€‚" }
                        ]
                    }
                ]
            },
            grammarQuiz: [
                {
                    q: "I ___ a musician.",
                    options: ["am", "is", "are", "be"],
                    answer: "am",
                    hint: "ç¬¬ä¸€äººç¨± I æ­é… amã€‚"
                },
                {
                    q: "The table is made ___ wood.",
                    options: ["from", "of", "by", "in"],
                    answer: "of",
                    hint: "be made of è¡¨ç¤ºç‰©ç†è®ŠåŒ–ï¼ˆçœ‹å¾—å‡ºåŸæ–™ï¼‰ã€‚"
                },
                {
                    q: "She helps ___ the homework.",
                    options: ["at", "on", "with", "to"],
                    answer: "with",
                    hint: "help with + åè© (help with the homework)ã€‚"
                },
                {
                    q: "He helps ___ the house.",
                    options: ["clean", "cleaning", "cleaned", "cleans"],
                    answer: "clean",
                    hint: "help + (to) åŸå½¢å‹•è©ã€‚"
                },
                {
                    q: "The boys ___ playing basketball.",
                    options: ["am", "is", "are", "be"],
                    answer: "are",
                    hint: "è¤‡æ•¸ä¸»è© (The boys) æ­é… areã€‚"
                },
                {
                    q: "This chair is made ___ plastic.",
                    options: ["by", "of", "from", "in"],
                    answer: "of",
                    hint: "be made of è¡¨ç¤ºç‰©ç†è®ŠåŒ–ã€‚"
                },
                {
                    q: "Can you help me ___ the door?",
                    options: ["open", "opening", "opened", "opens"],
                    answer: "open",
                    hint: "help + åŸå½¢å‹•è©ã€‚"
                },
                {
                    q: "She ___ my sister.",
                    options: ["are", "am", "is", "be"],
                    answer: "is",
                    hint: "ç¬¬ä¸‰äººç¨±å–®æ•¸ She æ­é… isã€‚"
                }
            ]
        },
        2: {
            title: "Week 2: Winter & History",
            vocab: [
                { en: "player", zh: "ç©å®¶; é¸æ‰‹", part: "n." },
                { en: "hit", zh: "æ‰“; æ’", part: "v." },
                { en: "point", zh: "é»; åˆ†", part: "n." },
                { en: "win", zh: "è´; ç²å‹", part: "v." },
                { en: "annoying", zh: "æƒ±äººçš„", part: "adj.", variants: "more annoying, most annoying" },
                { en: "fun", zh: "æœ‰è¶£çš„", part: "adj.", variants: "funner, funnest" },
                { en: "there was", zh: "æœ‰ (éå»å¼)", part: "phr." },
                { en: "a lot", zh: "å¾ˆå¤š", part: "phr." },
                { en: "snow", zh: "é›ª", part: "n." },
                { en: "team", zh: "åœ˜éšŠ", part: "n." },
                { en: "snowball fight", zh: "æ‰“é›ªä»—", part: "n." },
                { en: "jar", zh: "ç½å­", part: "n." },
                { en: "King", zh: "åœ‹ç‹", part: "Proper n." },
                { en: "wife", zh: "å¦»å­", part: "n." },
                { en: "Queen", zh: "çš‡å", part: "Proper n." },
                { en: "too much", zh: "å¤ªå¤š", part: "phr." },
                { en: "there is", zh: "æœ‰", part: "phr." },
                { en: "work", zh: "å·¥ä½œ; é‹è½‰", part: "v." },
                { en: "find", zh: "ç™¼ç¾; æ‰¾åˆ°", part: "v." },
                { en: "tomb", zh: "å¢“", part: "n." },
                { en: "water", zh: "æ°´", part: "n." },
                { en: "into", zh: "é€²å…¥", part: "prep." }
            ],
            sentences: [
                { en: "It was a fun snowball fight", zh: "é‚£æ˜¯ä¸€å ´æœ‰è¶£çš„æ‰“é›ªä»—" },
                { en: "The player wants to win", zh: "é‚£ä½é¸æ‰‹æƒ³è¦è´" },
                { en: "There was a lot of snow", zh: "é‚£è£¡æœ‰å¾ˆå¤šé›ª" },
                { en: "Our team got a point", zh: "æˆ‘å€‘çš„åœ˜éšŠå¾—äº†ä¸€åˆ†" },
                { en: "The sound is very annoying", zh: "é‚£å€‹è²éŸ³å¾ˆæƒ±äºº" },
                { en: "He hit the ball", zh: "ä»–æ“Šä¸­äº†çƒ" },
                { en: "Playing in the snow is fun", zh: "åœ¨é›ªä¸­ç©è€å¾ˆæœ‰è¶£" },
                { en: "The King and Queen are here", zh: "åœ‹ç‹å’Œçš‡ååœ¨é€™è£¡" },
                { en: "They found a jar in the tomb", zh: "ä»–å€‘åœ¨å¢“è£¡ç™¼ç¾äº†ä¸€å€‹ç½å­" },
                { en: "He goes to work every day", zh: "ä»–æ¯å¤©å»å·¥ä½œ" },
                { en: "There is too much water", zh: "æœ‰å¤ªå¤šçš„æ°´" },
                { en: "She went into the room", zh: "å¥¹èµ°é€²äº†æˆ¿é–“" }
            ],
            grammar: {
                title: "ç¾åœ¨ç°¡å–®å¼ï¼šå¦å®šå½¢å¼",
                subtitle: "Present Simple Negative",
                content: [
                    {
                        type: "rule",
                        title: "åŸºæœ¬å¥å¼",
                        desc: "Subject + don't / doesn't + Verb (Base Form)",
                        highlight: true,
                        examples: [
                            { en: "Things in the tomb don't look very good.", zh: "å¢“è£¡çš„æ±è¥¿çœ‹èµ·ä¾†ä¸å¤ªå¥½ã€‚" },
                            { en: "She doesn't like carrots.", zh: "å¥¹ä¸å–œæ­¡èƒ¡è˜¿è””ã€‚" },
                            { en: "We don't want your help.", zh: "æˆ‘å€‘ä¸æƒ³è¦ä½ çš„å¹«åŠ©ã€‚" }
                        ]
                    },
                    {
                        type: "table",
                        title: "åŠ©å‹•è©è¦å‰‡",
                        data: [
                            { sub: "I / You / We / They", aux: "don't (do not)" },
                            { sub: "He / She / It", aux: "doesn't (does not)" }
                        ]
                    },
                    {
                        type: "rule",
                        title: "èƒ½ / ä¸èƒ½ (Can / Can't)",
                        desc: "æƒ…æ…‹åŠ©å‹•è©ï¼Œè¡¨ç¤ºèƒ½åŠ›æˆ–è¨±å¯ï¼Œå¾Œé¢æ¥åŸå½¢å‹•è©ã€‚",
                        examples: [
                            { en: "I can swim.", zh: "æˆ‘æœƒæ¸¸æ³³ã€‚" },
                            { en: "He can't drive.", zh: "ä»–ä¸æœƒé–‹è»Šã€‚" }
                        ]
                    },
                    {
                        type: "rule",
                        title: "instead of (ä»£æ›¿ / è€Œä¸æ˜¯)",
                        desc: "å¾Œé¢æ¥åè© (N.) æˆ–å‹•åè© (V-ing)ã€‚",
                        examples: [
                            { en: "I want tea instead of coffee.", zh: "æˆ‘æƒ³è¦èŒ¶è€Œä¸æ˜¯å’–å•¡ã€‚" },
                            { en: "He walked instead of driving.", zh: "ä»–èµ°è·¯è€Œä¸æ˜¯é–‹è»Šã€‚" }
                        ]
                    },
                    {
                        type: "rule",
                        title: "be careful with (å°å¿ƒ...)",
                        desc: "æé†’æŸäººå°å¿ƒè™•ç†æŸç‰©æˆ–æŸæƒ…æ³ã€‚",
                        examples: [
                            { en: "Be careful with that knife.", zh: "å°å¿ƒé‚£æŠŠåˆ€ã€‚" },
                            { en: "Please be careful with my glasses.", zh: "è«‹å°å¿ƒæˆ‘çš„çœ¼é¡ã€‚" }
                        ]
                    }
                ]
            },
            grammarQuiz: [
                {
                    q: "She ___ like carrots.",
                    options: ["don't", "doesn't", "isn't", "aren't"],
                    answer: "doesn't",
                    hint: "ç¬¬ä¸‰äººç¨±å–®æ•¸ (She) ä½¿ç”¨ doesn'tã€‚"
                },
                {
                    q: "I ___ swim very fast.",
                    options: ["cans", "can", "to can", "canning"],
                    answer: "can",
                    hint: "æƒ…æ…‹åŠ©å‹•è© can å¾Œé¢æ¥åŸå½¢å‹•è©ï¼Œä¸”ä¸éš¨äººç¨±è®ŠåŒ–ã€‚"
                },
                {
                    q: "I want tea instead ___ coffee.",
                    options: ["of", "for", "with", "to"],
                    answer: "of",
                    hint: "ç‰‡èª instead of (ä»£æ›¿)ã€‚"
                },
                {
                    q: "Please be careful ___ that knife.",
                    options: ["about", "of", "with", "at"],
                    answer: "with",
                    hint: "be careful with + ç‰©å“ã€‚"
                },
                {
                    q: "They ___ want to go.",
                    options: ["doesn't", "don't", "isn't", "aren't"],
                    answer: "don't",
                    hint: "è¤‡æ•¸ä¸»è© (They) çš„å¦å®šåŠ©å‹•è©ç”¨ don'tã€‚"
                },
                {
                    q: "___ you help me?",
                    options: ["Can", "Are", "Do", "Is"],
                    answer: "Can",
                    hint: "è¡¨ç¤ºè«‹æ±‚èƒ½åŠ›ï¼Œç”¨ Can é–‹é ­ã€‚"
                },
                {
                    q: "He went to the park instead of ___ at home.",
                    options: ["stay", "staying", "stayed", "to stay"],
                    answer: "staying",
                    hint: "instead of å¾Œé¢æ¥å‹•åè© (V-ing)ã€‚"
                },
                {
                    q: "Be careful ___ the hot water.",
                    options: ["at", "on", "with", "to"],
                    answer: "with",
                    hint: "be careful with + ç‰©å“ã€‚"
                }
            ]
        },
        3: {
            title: "English Vocab: Week 3",
            vocab: [{ en: "coming soon", zh: "å³å°‡æ¨å‡º", part: "..." }],
            sentences: [{ en: "Coming soon", zh: "å…§å®¹å³å°‡æ¨å‡º" }],
            grammar: { title: "Coming Soon", content: [] },
            grammarQuiz: []
        }
    };

    // --- State Management ---
    let currentWeek = 1;
    let vocabList = [];
    let sentenceList = [];
    let currentGrammar = null;
    let currentGrammarQuiz = [];
    
    let currentMode = 'study';
    let currentStudyView = 'card'; // 'card' or 'list'
    let currentIndex = 0;
    
    // Quiz State
    let score = 0;
    let streak = 0;
    let currentQuizItem = null;

    // Sentence State
    let currentSentIndex = 0;
    let currentSentWords = [];
    let placedWords = [];
    let availableBankWords = [];

    // Grammar Quiz State
    let currentGQuizIndex = 0;

    // --- Initialization ---
    function init() {
        loadWeek(1);
        // Fix for mobile height issues on initialization
        window.addEventListener('resize', () => {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });
    }

    // --- Sidebar Logic ---
    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const isClosed = sidebar.classList.contains('-translate-x-full');

        if (isClosed) {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden', 'opacity-0');
            document.body.style.overflow = 'hidden'; // Lock body scroll
        } else {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);
            document.body.style.overflow = ''; // Unlock body scroll
        }
    }

    window.loadWeek = function(weekId) {
        currentWeek = weekId;
        const data = courseData[weekId];
        
        vocabList = JSON.parse(JSON.stringify(data.vocab));
        sentenceList = JSON.parse(JSON.stringify(data.sentences));
        currentGrammar = data.grammar;
        currentGrammarQuiz = data.grammarQuiz || [];
        
        document.getElementById('header-title').innerText = data.title;
        
        [1, 2, 3].forEach(id => {
            const btn = document.getElementById(`week-btn-${id}`);
            if(id === weekId) {
                btn.classList.add('bg-violet-50', 'text-violet-700');
            } else {
                btn.classList.remove('bg-violet-50', 'text-violet-700');
            }
        });

        // Reset State
        currentIndex = 0;
        currentSentIndex = 0;
        currentGQuizIndex = 0;
        score = 0;
        streak = 0;
        updateStats();

        // Separate shuffle for Flashcards and Quiz to keep list view somewhat consistent (optional, but shuffling list view is better for learning)
        shuffle(vocabList);
        shuffle(sentenceList);

        // Update Views
        updateFlashcard();
        renderStudyList(); 
        if (currentMode === 'sentence') initSentenceLevel();
        if (currentMode === 'quiz') nextQuestion();
        if (currentMode === 'grammar') renderGrammar();
        if (currentMode === 'grammar-quiz') initGrammarQuiz();

        const sidebar = document.getElementById('sidebar');
        if (!sidebar.classList.contains('-translate-x-full')) {
            toggleSidebar();
        }
    }

    // --- Mode Switching ---
    window.switchMode = function(mode) {
        currentMode = mode;
        const btns = ['btn-study', 'btn-sentence', 'btn-quiz', 'btn-grammar', 'btn-grammar-quiz'];
        const views = ['view-study', 'view-sentence', 'view-quiz', 'view-grammar', 'view-grammar-quiz'];

        btns.forEach(b => {
            const btn = document.getElementById(b);
            if (b === `btn-${mode}`) {
                btn.className = "snap-center flex-1 min-w-[70px] py-2.5 rounded-xl text-sm font-bold transition-all bg-white text-violet-600 shadow-sm whitespace-nowrap active:scale-95";
            } else {
                btn.className = "snap-center flex-1 min-w-[70px] py-2.5 rounded-xl text-sm font-bold transition-all text-white hover:bg-white/10 whitespace-nowrap active:scale-95";
            }
        });

        views.forEach(v => {
            document.getElementById(v).classList.add('hidden');
        });
        document.getElementById(`view-${mode}`).classList.remove('hidden');

        // Scroll content area to top
        document.getElementById('content-area').scrollTop = 0;

        if (mode === 'quiz') nextQuestion();
        if (mode === 'sentence') initSentenceLevel();
        if (mode === 'grammar') renderGrammar();
        if (mode === 'grammar-quiz') initGrammarQuiz();
    }

    // ==========================================
    // ğŸ“– STUDY MODE: Card vs List
    // ==========================================
    
    window.setStudyView = function(viewMode) {
        currentStudyView = viewMode;
        const cardView = document.getElementById('study-mode-card');
        const listView = document.getElementById('study-mode-list');
        const btnCard = document.getElementById('view-toggle-card');
        const btnList = document.getElementById('view-toggle-list');

        if (viewMode === 'card') {
            cardView.classList.remove('hidden');
            listView.classList.add('hidden');
            
            btnCard.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-gray-800 shadow-sm flex items-center gap-1";
            btnList.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-400 hover:text-gray-600 flex items-center gap-1";
        } else {
            cardView.classList.add('hidden');
            listView.classList.remove('hidden');
            
            btnCard.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-400 hover:text-gray-600 flex items-center gap-1";
            btnList.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-gray-800 shadow-sm flex items-center gap-1";
            
            renderStudyList();
        }
    }

    function renderStudyList() {
        const container = document.getElementById('vocab-list-container');
        container.innerHTML = '';

        if(vocabList.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 py-10">No vocabulary loaded.</p>';
            return;
        }

        vocabList.forEach(item => {
            const el = document.createElement('div');
            el.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group active:scale-[0.99] transition-all";
            el.onclick = () => speakText(item.en);
            
            let variantsHtml = '';
            if (item.variants) {
                variantsHtml = `<span class="text-xs text-gray-400 ml-2 font-normal">(${item.variants})</span>`;
            }

            el.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-baseline gap-2 mb-1">
                        <h3 class="text-lg font-bold text-gray-800">${item.en}</h3>
                        <span class="text-xs font-bold text-violet-500 bg-violet-50 px-1.5 py-0.5 rounded">${item.part}</span>
                    </div>
                    <p class="text-gray-600 text-sm">${item.zh} ${variantsHtml}</p>
                </div>
                <button class="p-2 rounded-full text-violet-300 group-hover:bg-violet-50 group-hover:text-violet-600 transition-colors">
                    <i data-lucide="volume-2" class="w-5 h-5"></i>
                </button>
            `;
            container.appendChild(el);
        });
        
        lucide.createIcons();
    }


    // ==========================================
    // ğŸ“š GRAMMAR RENDERER
    // ==========================================
    function renderGrammar() {
        const container = document.getElementById('view-grammar');
        if(!currentGrammar) {
            container.innerHTML = `<div class="p-8 text-center text-gray-400">æœ¬é€±å°šç„¡æ–‡æ³•å…§å®¹</div>`;
            return;
        }

        let html = `
            <div class="mb-6 bg-violet-50 p-6 rounded-2xl border border-violet-100">
                <h2 class="text-2xl font-bold text-violet-800">${currentGrammar.title}</h2>
                ${currentGrammar.subtitle ? `<p class="text-violet-500 font-medium mt-1">${currentGrammar.subtitle}</p>` : ''}
            </div>
        `;

        currentGrammar.content.forEach(section => {
            if(section.type === 'rule') {
                html += `
                    <div class="mb-6 bg-white rounded-2xl border-l-4 border-violet-500 shadow-sm p-5 ring-1 ring-gray-100">
                        <h3 class="font-bold text-lg text-gray-800 mb-2 flex items-center gap-2">
                            <i data-lucide="book-open" class="w-4 h-4 text-violet-500"></i> ${section.title}
                        </h3>
                        ${section.desc ? `<p class="text-gray-600 mb-4 leading-relaxed ${section.highlight ? 'bg-amber-50 p-3 rounded-lg text-amber-800 font-mono text-sm border border-amber-100' : ''}">${section.desc}</p>` : ''}
                        
                        ${section.examples ? `
                            <div class="space-y-3 mt-4">
                                ${section.examples.map(ex => `
                                    <div class="cursor-pointer group hover:bg-gray-50 p-3 rounded-xl transition-colors border border-transparent hover:border-gray-100" onclick="speakText('${ex.en.replace(/'/g, "\\'")}')">
                                        <div class="flex items-start gap-3">
                                            <div class="mt-1 p-2 bg-violet-100 rounded-full text-violet-600 shrink-0 group-hover:bg-violet-200 transition-colors">
                                                <i data-lucide="volume-2" class="w-4 h-4"></i>
                                            </div>
                                            <div>
                                                <p class="text-gray-800 font-bold text-base md:text-lg group-hover:text-violet-700 transition-colors">${ex.en}</p>
                                                <p class="text-gray-400 text-sm">${ex.zh}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (section.type === 'table') {
                html += `
                    <div class="mb-6 bg-white rounded-2xl shadow-sm overflow-hidden ring-1 ring-gray-100">
                        <div class="bg-gray-50 px-5 py-3 border-b border-gray-100">
                            <h3 class="font-bold text-gray-700 text-sm flex items-center gap-2">
                                <i data-lucide="table" class="w-4 h-4"></i> ${section.title}
                            </h3>
                        </div>
                        <div class="divide-y divide-gray-100">
                            ${section.data.map(row => `
                                <div class="flex p-4 text-base">
                                    <div class="w-1/2 font-medium text-gray-800">${row.sub}</div>
                                    <div class="w-1/2 text-violet-600 font-mono font-bold text-right">${row.aux}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        });
        
        container.innerHTML = html;
        lucide.createIcons();
    }

    // ==========================================
    // ğŸ“ GRAMMAR QUIZ LOGIC
    // ==========================================
    function initGrammarQuiz() {
        if (!currentGrammarQuiz || currentGrammarQuiz.length === 0) {
            document.getElementById('view-grammar-quiz').innerHTML = 
                '<div class="flex flex-col items-center justify-center h-full text-gray-400"><i data-lucide="alert-circle" class="w-12 h-12 mb-2"></i><p>æœ¬é€±å°šç„¡æ–‡æ³•æ¸¬é©—</p></div>';
            lucide.createIcons();
            return;
        }
        currentGQuizIndex = 0;
        renderGrammarQuiz();
    }

    function renderGrammarQuiz() {
        const item = currentGrammarQuiz[currentGQuizIndex];
        document.getElementById('g-quiz-progress').innerText = `${currentGQuizIndex + 1} / ${currentGrammarQuiz.length}`;
        document.getElementById('g-quiz-q').innerText = item.q;
        
        // Reset Feedback
        document.getElementById('g-quiz-feedback').innerHTML = '';
        
        const optionsDiv = document.getElementById('g-quiz-options');
        optionsDiv.innerHTML = '';
        
        item.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-xl text-gray-700 font-bold hover:bg-violet-50 hover:border-violet-200 transition-all active:scale-[0.98]";
            btn.innerText = opt;
            btn.onclick = () => checkGrammarAnswer(opt, item, btn);
            optionsDiv.appendChild(btn);
        });
    }

    function checkGrammarAnswer(selected, item, btn) {
        const feedbackDiv = document.getElementById('g-quiz-feedback');
        const optionsDiv = document.getElementById('g-quiz-options');
        
        // Disable all buttons
        const allBtns = optionsDiv.querySelectorAll('button');
        allBtns.forEach(b => b.disabled = true);

        if (selected === item.answer) {
            // Correct
            btn.classList.remove('bg-gray-50', 'border-gray-100', 'text-gray-700');
            btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            feedbackDiv.innerHTML = `<span class="text-green-600 font-bold flex items-center gap-2"><i data-lucide="check" class="w-5 h-5"></i> ç­”å°äº†ï¼</span>`;
            fireConfetti();
            
            setTimeout(() => {
                if (currentGQuizIndex < currentGrammarQuiz.length - 1) {
                    currentGQuizIndex++;
                    renderGrammarQuiz();
                } else {
                    feedbackDiv.innerHTML = `<span class="text-violet-600 font-bold">ğŸ‰ æ¸¬é©—å®Œæˆï¼å¤ªæ£’äº†ï¼</span>`;
                    // Reset or show completion screen
                    setTimeout(() => {
                        currentGQuizIndex = 0;
                        renderGrammarQuiz();
                    }, 3000);
                }
            }, 1500);

        } else {
            // Incorrect
            btn.classList.remove('bg-gray-50', 'border-gray-100', 'text-gray-700');
            btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            
            // Highlight correct answer
            allBtns.forEach(b => {
                if(b.innerText === item.answer) {
                    b.classList.add('bg-green-50', 'border-green-300', 'text-green-700');
                }
            });

            feedbackDiv.innerHTML = `
                <div class="flex flex-col items-center">
                    <span class="text-red-500 font-bold flex items-center gap-2 text-sm"><i data-lucide="x" class="w-4 h-4"></i> å†è©¦ä¸€æ¬¡</span>
                    ${item.hint ? `<span class="text-xs text-gray-500 mt-1">${item.hint}</span>` : ''}
                </div>
            `;
            
            // Allow retry after delay or specific logic
            // For now, auto advance after 2.5s to keep flow
            setTimeout(() => {
                 if (currentGQuizIndex < currentGrammarQuiz.length - 1) {
                    currentGQuizIndex++;
                    renderGrammarQuiz();
                } else {
                     feedbackDiv.innerHTML = `<span class="text-violet-600 font-bold">ğŸ‰ æ¸¬é©—å®Œæˆï¼</span>`;
                     setTimeout(() => {
                        currentGQuizIndex = 0;
                        renderGrammarQuiz();
                    }, 3000);
                }
            }, 2500);
        }
        lucide.createIcons();
    }


    window.speakText = function(text) {
        // Cancel existing speech to avoid overlap
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US'; 
        speechSynthesis.speak(utterance);
    }

    // ==========================================
    // ğŸ“– FLASHCARD LOGIC
    // ==========================================
    function updateFlashcard() {
        if(vocabList.length === 0) return;
        const item = vocabList[currentIndex];
        const cardInner = document.getElementById('flashcard-inner');
        
        // Reset flip immediately
        cardInner.style.transform = 'rotateY(0deg)'; 

        // Delay content update slightly for smooth transition feel if was flipped
        setTimeout(() => {
            let displayEn = item.en;
            if(item.variants) displayEn += `<br><span class="text-lg font-normal text-gray-400 mt-2 block">${item.variants}</span>`;
            
            document.getElementById('fc-en').innerHTML = displayEn;
            document.getElementById('fc-zh').innerText = item.zh;
            document.getElementById('fc-part').innerText = item.part;
            document.getElementById('fc-counter').innerText = currentIndex + 1;
            document.getElementById('fc-total').innerText = vocabList.length;
        }, 200);
    }

    window.flipCard = function() {
        const cardInner = document.getElementById('flashcard-inner');
        const isFlipped = cardInner.style.transform === 'rotateY(180deg)';
        cardInner.style.transform = isFlipped ? 'rotateY(0deg)' : 'rotateY(180deg)';
    }

    window.nextCard = function() {
        currentIndex = (currentIndex + 1) % vocabList.length;
        updateFlashcard();
    }

    window.prevCard = function() {
        currentIndex = (currentIndex - 1 + vocabList.length) % vocabList.length;
        updateFlashcard();
    }

    window.speakWord = function(e) {
        // Prevent card flip if button clicked inside card area (though button is outside now)
        if(e) e.stopPropagation(); 
        
        if(vocabList.length === 0) return;
        const item = vocabList[currentIndex];
        
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(item.en);
        utterance.lang = 'en-US'; 
        speechSynthesis.speak(utterance);
    }

    // ==========================================
    // ğŸ§© SENTENCE BUILDER LOGIC
    // ==========================================
    function initSentenceLevel() {
        if(sentenceList.length === 0) return;
        currentSentIndex = 0;
        loadSentence();
    }

    function loadSentence() {
        const sentObj = sentenceList[currentSentIndex];
        document.getElementById('sent-zh').innerText = sentObj.zh;
        document.getElementById('sent-progress').innerText = `${currentSentIndex + 1} / ${sentenceList.length}`;
        document.getElementById('sent-feedback').classList.add('hidden');

        // Prepare words
        const words = sentObj.en.replace(/[.,]/g,"").split(/\s+/);
        currentSentWords = words; 
        
        availableBankWords = words.map((w, i) => ({ word: w, id: i }));
        shuffle(availableBankWords);
        placedWords = []; 

        renderSent();
    }

    function renderSent() {
        const slotsDiv = document.getElementById('sent-slots');
        const bankDiv = document.getElementById('sent-bank');
        slotsDiv.innerHTML = '';
        bankDiv.innerHTML = '';

        if (placedWords.length === 0) {
            slotsDiv.innerHTML = `<span class="text-violet-300 text-sm w-full text-center py-4 select-none pointer-events-none font-medium italic">é»æ“Šä¸‹æ–¹å–®å­—ä¾åºæ’åˆ—...</span>`;
        } else {
            placedWords.forEach((obj, idx) => {
                const chip = createChip(obj.word, 'bg-white text-violet-700 border-violet-200 hover:bg-red-50 hover:border-red-200 hover:text-red-500 shadow-sm', () => removeWord(idx));
                slotsDiv.appendChild(chip);
            });
        }

        availableBankWords.forEach((obj, idx) => {
            const chip = createChip(obj.word, 'bg-white border-gray-200 text-gray-700 hover:border-violet-400 hover:text-violet-600 shadow-sm active:bg-violet-50', () => pickWord(idx));
            bankDiv.appendChild(chip);
        });

        checkSentenceCompletion();
    }

    function createChip(text, classes, onClick) {
        const btn = document.createElement('div');
        btn.className = `word-chip px-4 py-2 md:px-5 md:py-3 rounded-xl font-bold border-2 text-lg md:text-xl ${classes}`;
        btn.innerText = text;
        btn.onclick = onClick;
        return btn;
    }

    function pickWord(bankIdx) {
        const item = availableBankWords.splice(bankIdx, 1)[0];
        placedWords.push(item);
        renderSent();
    }

    function removeWord(placedIdx) {
        const item = placedWords.splice(placedIdx, 1)[0];
        availableBankWords.push(item);
        renderSent();
    }

    function checkSentenceCompletion() {
        if (availableBankWords.length === 0) {
            const attempt = placedWords.map(o => o.word).join(" ");
            const target = currentSentWords.join(" ");
            
            if (attempt === target) {
                document.getElementById('sent-feedback').classList.remove('hidden');
                fireConfetti();
                speakText(attempt); // Auto speak correct sentence
            } else {
                const slots = document.getElementById('sent-slots');
                slots.classList.add('border-red-400', 'bg-red-50');
                if('vibrate' in navigator) navigator.vibrate(200); // Haptic feedback
                setTimeout(() => slots.classList.remove('border-red-400', 'bg-red-50'), 500);
            }
        }
    }

    window.nextSentence = function() {
        currentSentIndex = (currentSentIndex + 1) % sentenceList.length;
        loadSentence();
    }

    // ==========================================
    // ğŸ¯ QUIZ LOGIC
    // ==========================================
    window.nextQuestion = function() {
        if(vocabList.length === 0) return;

        const overlay = document.getElementById('feedback-overlay');
        overlay.classList.add('hidden');
        overlay.classList.remove('flex');
        
        currentQuizItem = vocabList[Math.floor(Math.random() * vocabList.length)];
        document.getElementById('q-word').innerText = currentQuizItem.en;

        let options = [currentQuizItem];
        let pool = [...vocabList];
        
        // Add fallback dummy data if list is small
        if(pool.length < 4) {
             pool.push({zh: "è˜‹æœ"}, {zh: "é¦™è•‰"}, {zh: "è²“"});
        }

        while (options.length < 4) {
            let rand = pool[Math.floor(Math.random() * pool.length)];
            if (!options.some(o => o.zh === rand.zh)) options.push(rand);
        }
        shuffle(options);

        const grid = document.getElementById('options-grid');
        grid.innerHTML = '';
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "w-full p-5 md:p-6 bg-white border-2 border-gray-100 rounded-2xl text-gray-600 font-bold hover:border-violet-400 hover:text-violet-600 hover:bg-violet-50 transition-all text-left shadow-sm active:scale-[0.98] text-lg md:text-xl flex items-center justify-between group";
            btn.innerHTML = `
                <span>${opt.zh}</span>
                <i data-lucide="circle" class="w-5 h-5 text-gray-200 group-hover:text-violet-300"></i>
            `;
            btn.onclick = () => checkAnswer(opt, btn);
            grid.appendChild(btn);
        });
        
        // Re-init icons for new elements
        lucide.createIcons();
    }

    function checkAnswer(selected, btnElement) {
        const overlay = document.getElementById('feedback-overlay');
        const icon = document.getElementById('feedback-icon');
        const text = document.getElementById('feedback-text');
        
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
        
        // Force reflow
        void overlay.offsetWidth;
        overlay.classList.remove('opacity-0');
        icon.classList.remove('scale-0');
        icon.classList.add('scale-100');

        if (selected === currentQuizItem) {
            score += 10;
            streak++;
            icon.innerText = "ğŸ‰";
            text.innerText = "Correct!";
            text.className = "text-4xl font-black text-green-500 mb-6";
            
            // Highlight button
            btnElement.classList.remove('border-gray-100', 'text-gray-600');
            btnElement.classList.add('bg-green-50', 'border-green-500', 'text-green-700');
            // FIX: Re-render button content with new icon instead of searching for <i>
            btnElement.innerHTML = `
                <span>${selected.zh}</span>
                <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
            `;
            
            fireConfetti();
            if('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
        } else {
            streak = 0;
            icon.innerText = "ğŸ˜¢";
            text.innerHTML = `<span class="text-sm text-gray-400 font-normal block mb-2">The answer is</span>${currentQuizItem.zh}`;
            text.className = "text-3xl font-bold text-gray-800 mb-6";
            
            btnElement.classList.remove('border-gray-100', 'text-gray-600');
            btnElement.classList.add('bg-red-50', 'border-red-500', 'text-red-700');
            // FIX: Re-render button content with new icon instead of searching for <i>
            btnElement.innerHTML = `
                <span>${selected.zh}</span>
                <i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>
            `;
            
            if('vibrate' in navigator) navigator.vibrate(300);
        }
        lucide.createIcons();
        updateStats();
    }

    function updateStats() {
        document.getElementById('score-display').innerText = score;
        document.getElementById('streak-display').innerText = "ğŸ”¥ " + streak;
    }

    function fireConfetti() {
        if (typeof confetti !== 'undefined') {
            confetti({
                particleCount: 150,
                spread: 80,
                origin: { y: 0.6 },
                colors: ['#8B5CF6', '#F472B6', '#34D399', '#FBBF24'],
                disableForReducedMotion: true
            });
        }
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // Start
    init();

</script>
</body>
</html>
